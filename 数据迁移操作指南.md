# 数据迁移操作指南

## 📋 当前状况

### 云数据库现状
- ✅ 已有 `questions` 集合
- ✅ 包含72页语法填空题目数据
- ✅ 数据结构：`text`, `answer`, `analysis`, `category`, `createdAt`, `updatedAt`

### 本地数据现状
- 📁 `miniprogram/data/intermediate_questions.js` (1.4MB)
- 📝 包含语法填空题目 + 笔记内容 + 可交互表格
- 🔄 数据已更新，未同步到云数据库

## 🎯 推荐方案：扩展现有集合

### 优势
1. **统一管理**: 所有数据在一个集合中，便于查询
2. **避免重复**: 不需要创建多个集合
3. **简化维护**: 减少集合数量，降低管理复杂度

### 数据结构设计
```javascript
{
  "_id": "唯一标识",
  "category": "分类名称",
  "type": "question|note|table",  // 新增字段
  "text": "题目文本",
  "answer": "答案",
  "analysis": "解析",
  "notes": "笔记内容",           // 笔记类型特有
  "table": "表格数据",           // 表格类型特有
  "interactive": true,           // 表格类型特有
  "order": 1,
  "createTime": "创建时间",
  "updateTime": "更新时间",
  "source": "数据来源"
}
```

## 🚀 操作步骤

### 第一步：备份现有云数据库数据
1. 在微信开发者工具中打开云开发控制台
2. 进入数据库管理页面
3. 选择 `questions` 集合
4. 执行以下代码备份数据：

```javascript
// 在云开发控制台执行
const db = wx.cloud.database();
const questionsCollection = db.collection('questions');

async function backupData() {
  const allData = [];
  let offset = 0;
  const limit = 100;
  
  while (true) {
    const result = await questionsCollection
      .skip(offset)
      .limit(limit)
      .get();
    
    if (result.data.length === 0) {
      break;
    }
    
    allData.push(...result.data);
    offset += limit;
    console.log(`已获取 ${allData.length} 条数据`);
  }
  
  console.log('备份数据:', JSON.stringify(allData, null, 2));
  return allData;
}

backupData();
```

### 第二步：准备本地数据迁移
1. 运行数据迁移脚本：
```bash
node migrate_data_to_cloud.js
```

2. 检查生成的文件：
   - `cloud_import_script.js` - 云数据库导入脚本
   - `frontend_example.js` - 前端调用示例

### 第三步：合并数据到云数据库
1. 在云开发控制台执行 `cloud_import_script.js`
2. 脚本会自动：
   - 检查重复数据
   - 添加新数据
   - 设置正确的类型标识

### 第四步：验证数据完整性
1. 检查云数据库中的数据数量
2. 验证不同类型数据的完整性
3. 测试云函数调用

### 第五步：删除本地数据文件
1. 确认云数据库数据完整后
2. 删除 `miniprogram/data/intermediate_questions.js`
3. 重新编译小程序

## 📝 云函数调用示例

### 获取题目数据
```javascript
// 获取指定分类的题目
const questions = await wx.cloud.callFunction({
  name: 'getQuestionsData',
  data: {
    action: 'getQuestionsByCategory',
    category: '介词综合',
    type: 'question',
    limit: 20,
    offset: 0
  }
});
```

### 获取笔记数据
```javascript
// 获取笔记内容
const notes = await wx.cloud.callFunction({
  name: 'getQuestionsData',
  data: {
    action: 'getNotes',
    limit: 10,
    offset: 0
  }
});
```

### 获取表格数据
```javascript
// 获取可交互表格
const tables = await wx.cloud.callFunction({
  name: 'getQuestionsData',
  data: {
    action: 'getTables',
    limit: 10,
    offset: 0
  }
});
```

## ⚠️ 注意事项

### 数据安全
1. **备份优先**: 执行任何操作前先备份现有数据
2. **分批处理**: 大量数据分批导入，避免超时
3. **验证数据**: 每个步骤后验证数据完整性

### 性能考虑
1. **索引优化**: 为 `category` 和 `type` 字段创建索引
2. **分页查询**: 使用 `limit` 和 `offset` 进行分页
3. **缓存策略**: 考虑在前端缓存常用数据

### 错误处理
1. **网络异常**: 处理云函数调用失败的情况
2. **数据格式**: 确保数据格式正确
3. **重复数据**: 避免导入重复数据

## 🔍 验证清单

- [ ] 云数据库数据备份完成
- [ ] 本地数据迁移脚本运行成功
- [ ] 云数据库数据导入完成
- [ ] 数据完整性验证通过
- [ ] 云函数调用测试通过
- [ ] 前端代码更新完成
- [ ] 本地数据文件删除
- [ ] 小程序重新编译成功
- [ ] 功能测试通过

## 📞 技术支持

如果遇到问题，可以：
1. 检查云开发控制台的错误日志
2. 验证数据格式是否正确
3. 确认云函数权限设置
4. 查看网络连接状态

---

**操作时间**: 预计 30-60 分钟
**风险等级**: 中等（需要备份数据）
**预期效果**: 主包大小减少 1.4MB，数据管理更灵活
