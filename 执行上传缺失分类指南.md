# 执行上传缺失分类指南

## 📊 上传内容

**14 个缺失分类，共 381 题**

1. "介词综合" (28题)
2. "固定搭配" (25题)
3. "介词 + 名词/动名词" (30题)
4. "f/fe结尾" (16题)
5. "谓语(1)" (57题)
6. "副词修饰句子" (29题)
7. "谓语(2)" (19题)
8. "谓语(3)" (27题)
9. "谓语(4)" (20题)
10. "谓语(5)" (42题)
11. "谓语(6)" (16题)
12. "谓语(7)" (24题)
13. "谓语(8)" (15题)
14. "谓语(9)" (33题)

## 🚀 执行步骤

### 方法一：在小程序控制台直接运行（推荐）

1. **打开小程序开发者工具**
2. **打开控制台**（Console）
3. **复制并粘贴以下代码**，然后按回车：

```javascript
// 复制 run_upload_in_console.js 的全部内容到控制台
```

或者直接运行：

```javascript
require('./run_upload_in_console.js');
```

### 方法二：使用暴露的全局函数

1. **打开小程序开发者工具控制台**
2. **加载脚本**：
```javascript
require('./call_upload_missing_categories.js');
```

3. **执行上传**：
```javascript
uploadAllMissingCategories();
```

4. **验证结果**：
```javascript
verifyUploadResults();
```

## ⏱️ 预计时间

- 上传 14 个分类 × 500ms 间隔 = 约 7 秒
- 云函数执行时间：每个分类约 1-2 秒
- **总计约 1-2 分钟**

## ✅ 成功标志

控制台应该显示：

```
🎉 批量上传完成！
✅ 成功上传: 381 题
❌ 失败分类: 0 个
📊 成功率: 100%
```

## 🔍 验证上传

上传完成后，脚本会自动验证每个分类的题目数量：

```
🔍 验证上传结果...
  - "介词综合": 28 题 ✅
  - "固定搭配": 25 题 ✅
  - "介词 + 名词/动名词": 30 题 ✅
  ...
```

## 🎯 上传后的效果

- **云数据库分类数量**: 从 54 个 → 66 个
- **前端与数据库匹配**: 100% 直接匹配
- **无需映射表**: 前端显示什么，数据库就有什么

## 📋 下一步

上传成功后：

1. **移除 `miniprogram/utils/questionMapping.js` 中的映射表逻辑**
2. **修改 `miniprogram/utils/cloudDataLoader.js`**：
   - 移除映射表导入
   - 直接使用 `category: grammarPoint` 查询
3. **测试前端选题功能**
4. **验证生成的学案内容**

## ❌ 故障排除

### 如果某个分类上传失败：

1. 查看控制台错误信息
2. 检查云函数 `uploadMissingCategories` 的日志
3. 确认云数据库权限设置
4. 手动重新上传失败的分类：

```javascript
const backupData = require('./backup/intermediate_questions_before_migration.js');

wx.cloud.callFunction({
  name: 'uploadMissingCategories',
  data: {
    category: "分类名称",
    questions: backupData["分类名称"]
  }
}).then(result => {
  console.log('上传结果:', result);
});
```

### 如果云函数不存在：

1. 确认 `cloudfunctions/uploadMissingCategories/index.js` 存在
2. 重新部署云函数：
```bash
cd cloudfunctions/uploadMissingCategories
npm install
```
3. 在微信开发者工具中右键 `uploadMissingCategories` → 上传并部署：云端安装依赖

## 📞 完成后确认

请在控制台运行以下代码确认所有分类都已上传：

```javascript
wx.cloud.database().collection('questions')
  .where({ category: _.exists(true) })
  .count()
  .then(result => {
    console.log(`数据库总题目数: ${result.total}`);
  });

// 检查分类数量
wx.cloud.database().collection('questions')
  .field({ category: true })
  .get()
  .then(result => {
    const categories = [...new Set(result.data.map(q => q.category))];
    console.log(`数据库分类数: ${categories.length}`);
    console.log('所有分类:', categories.sort());
  });
```

预期结果：
- 总题目数应该显著增加（增加 381 题）
- 分类数应该从 54 个增加到 66 个

