# 📋 映射表修复报告

## 🎯 测试结果总结

### 测试1：所有category唯一值统计
- **总题目数**: 2375道高中题目
- **唯一category数**: 69个
- **关键发现**: 数据库中**不存在"连词综合"**这个category

### 测试2：关键映射验证结果

| 映射目标 | 精确匹配 | 模糊匹配 | 状态 |
|---------|---------|---------|------|
| 连词综合 | ❌ 0题 | ✅ 58题 | **需要修复** |
| 时态综合 | ✅ 29题 | ✅ 29题 | ✓ 正常 |
| 谓语综合 | ✅ 57题 | ✅ 75题 | ✓ 正常 |
| 冠词综合 | ✅ 26题 | ✅ 26题 | ✓ 正常 |
| 形容词综合 | ✅ 29题 | ✅ 29题 | ✓ 正常 |
| 副词综合 | ✅ 14题 | ❌ 0题 | ⚠️ 题目较少 |
| 名词综合 | ✅ 25题 | ❌ 0题 | ⚠️ 题目较少 |
| 代词综合 | ✅ 68题 | ✅ 68题 | ✓ 正常 |
| 动词综合 | ✅ 64题 | ✅ 64题 | ✓ 正常 |

### 测试3：专题与子知识点对应关系

| 专题 | 找到题目数 | 涉及category数 | 主要category |
|------|-----------|---------------|-------------|
| 连词 | 58题 | 4个 | 连词与形容词(20), 连词与名/动/形/副综合(18), 从属连词综合(16) |
| 时态/谓语 | 86题 | 7个 | 谓语(1)(20), 谓语(3)(16), 谓语综合(15) |
| 冠词 | 2题 | 1个 | 冠词综合(2) |
| 形容词 | 20题 | 1个 | 连词与形容词(20) |
| 副词 | 0题 | 0个 | ⚠️ 未找到 |
| 名词 | 0题 | 0个 | ⚠️ 未找到 |
| 代词 | 40题 | 4个 | 关系代词(20), 代词综合(11), 人称代词(8) |
| 介词 | 20题 | 1个 | 介词综合(20) |
| 动词 | 23题 | 2个 | 并列句与动词(18), 动词综合(5) |
| 非谓语 | 20题 | 2个 | 不定式综合(13), 过去分词综合(7) |
| 从句 | 33题 | 2个 | 定语从句综合(20), 状语从句综合(13) |

---

## 🔧 已修复的问题

### 1. **"连词综合"映射错误** ✅ 已修复

**问题**:
- 映射表中将"连词综合"映射到"连词综合"
- 但数据库中**不存在"连词综合"**这个category
- 实际存在的连词相关category：
  - "并列连词综合" (26题)
  - "从属连词综合" (30题)
  - "连词与名词" (30题)
  - "连词与动词" (30题)
  - "连词与形容词" (27题)
  - "连词与名/动/形/副综合" (97题) ⭐ **最大的综合分类**

**修复方案**:
```javascript
// 修复前
conjunction: {
  "连词综合": "连词综合",  // ❌ 数据库中不存在
  "连词与名词": "连词综合",
  "连词与动词": "连词综合",
  "连词与形容词": "连词综合"
}

// 修复后
conjunction: {
  "连词综合": "连词与名/动/形/副综合",  // ✅ 映射到最大的综合分类
  "连词与名词": "连词与名词",
  "连词与动词": "连词与动词",
  "连词与形容词": "连词与形容词",
  "并列连词综合": "并列连词综合",
  "从属连词综合": "从属连词综合",
  "连词与名/动/形/副综合": "连词与名/动/形/副综合"
}
```

**同时修复了父分类映射**:
```javascript
// 修复前
"并列连词综合": "连词综合",  // ❌
"连词综合": "连词综合",      // ❌

// 修复后
"并列连词综合": "连词与名/动/形/副综合",  // ✅
"从属连词综合": "连词与名/动/形/副综合",  // ✅
"连词综合": "连词与名/动/形/副综合",      // ✅
```

---

## ⚠️ 需要注意的问题

### 1. **"副词"和"名词"专题查询结果为空**

**现象**:
- 测试3中，"副词"和"名词"专题没有找到任何题目
- 但测试1显示存在"副词综合"(14题)和"名词综合"(25题)

**可能原因**:
- 测试3使用关键词匹配（`cat.includes('副词')`），可能这些category的命名不包含这些关键词
- 或者这些题目确实很少，被其他分类覆盖了

**建议**:
- 检查"副词综合"和"名词综合"的category值是否真的包含"副词"和"名词"关键词
- 如果专题查询需要更精确，可能需要使用精确的category名称而不是关键词匹配

### 2. **"副词综合"和"名词综合"题目数量较少**

- "副词综合": 14题（可能不够用）
- "名词综合": 25题（可能不够用）

**建议**:
- 如果这些专题需要更多题目，可能需要：
  1. 添加更多相关题目到数据库
  2. 或者扩展映射，包含更多相关的category（如"副词修饰动词"、"副词修饰句子"等）

### 3. **"冠词"专题题目数量很少**

**现象**:
- 测试3中，"冠词"专题只找到2题
- 但测试1显示"冠词综合"有26题

**可能原因**:
- 测试3的关键词匹配可能有问题
- 或者"冠词综合"的category值不包含"冠词"关键词（不太可能）

**建议**:
- 检查测试3的过滤逻辑，确保能正确匹配"冠词综合"

---

## 📊 数据库category完整列表（按分组）

### 连词相关 (6个category, 约240题)
- 并列连词综合 (26题)
- 从属连词综合 (30题)
- 连词与名词 (30题)
- 连词与动词 (30题)
- 连词与形容词 (27题)
- 连词与名/动/形/副综合 (97题) ⭐

### 时态/谓语相关 (10个category, 约300题)
- 时态综合 (29题)
- 谓语综合 (57题)
- 谓语(1) (57题)
- 谓语(2) (19题)
- 谓语(3) (27题)
- 谓语(4) (20题)
- 谓语(5) (42题)
- 谓语(6) (16题)
- 谓语(7) (24题)
- 谓语(8) (15题)
- 谓语(9) (33题)

### 代词相关 (6个category, 约235题)
- 代词综合 (68题)
- 人称代词 (8题)
- 物主代词 (42题)
- 反身代词 (29题)
- 关系代词 (58题)
- it相关 (30题)

### 冠词相关 (4个category, 约113题)
- 冠词综合 (26题)
- 泛指与特指 (29题)
- a和an (30题)
- the的特殊用法 (28题)

### 动词相关 (5个category, 约174题)
- 动词综合 (64题)
- 并列句与动词 (21题)
- 主从句与动词 (30题)
- 插入语与动词 (29题)
- 被动语态 (30题)

### 非谓语相关 (4个category, 约96题)
- 非谓语综合 (10题)
- 现在分词综合 (27题)
- 过去分词综合 (29题)
- 不定式综合 (30题)

### 从句相关 (2个category, 约77题)
- 定语从句综合 (50题)
- 状语从句综合 (27题)

### 其他
- 副词综合 (14题)
- 名词综合 (25题)
- 形容词综合 (29题)
- 介词综合 (28题)
- 固定搭配 (25题)
- 未分类 (309题) ⚠️

---

## ✅ 修复验证

修复后，当查询"连词综合"时：
1. 会映射到"连词与名/动/形/副综合"
2. 可以查询到97道题目（最大的连词综合分类）
3. 如果还需要更多题目，可以通过父分类映射或模糊匹配获取其他连词相关的题目

---

## 📝 后续建议

### 1. **清理"未分类"题目** ⚠️ 优先级：高

**问题**: 有309道题目标记为"未分类"（category字段为空），占总数约13%

**影响**:
- 这些题目无法通过专题查询找到
- 影响题库的完整性和可用性
- 可能导致某些专题题目数量不足

**处理方案**:

#### 方案A：自动映射（推荐）✅
根据 `grammarPoint` 或 `tag` 字段自动分配 `category`：

1. **使用分析脚本** (`analyze_uncategorized_questions.js`):
   ```javascript
   // 在微信开发者工具控制台运行
   // 查看未分类题目的详细信息，包括grammarPoint/tag分布
   ```

2. **使用批量修复脚本** (`batch_fix_uncategorized_questions.js`):
   ```javascript
   // 第一步：模拟运行，查看修复计划
   batchFixUncategorizedQuestions(true);
   
   // 第二步：确认无误后，实际执行
   batchFixUncategorizedQuestions(false);
   ```

**映射规则**:
- 精确匹配：直接使用 `GRAMMAR_POINT_TO_CATEGORY` 映射表
- 模糊匹配：根据关键词自动推断（如包含"连词"→映射到连词相关分类）
- 无法匹配：需要人工审核

**预期效果**:
- 大部分题目可以通过 `grammarPoint/tag` 自动分类
- 预计可自动修复 200-250 题
- 剩余 50-100 题需要人工审核

#### 方案B：人工审核
对于无法自动匹配的题目：
1. 导出为Excel或CSV格式
2. 人工查看题目内容，手动分配category
3. 批量导入更新后的数据

#### 方案C：创建"其他"分类
如果部分题目确实无法归类，可以：
- 创建"其他"或"综合练习"分类
- 将这些题目统一归类，至少保证它们可以被查询到

**建议执行步骤**:
1. ✅ 先运行 `analyze_uncategorized_questions.js` 了解具体情况
2. ✅ 运行 `batch_fix_uncategorized_questions.js` 进行自动修复
3. ⚠️ 对于无法自动匹配的题目，人工审核或创建"其他"分类
4. ✅ 验证修复结果，确保所有题目都有category

---

### 2. **优化专题查询逻辑**

- 测试3的关键词匹配可能不够精确
- 建议使用精确的category名称列表，而不是关键词匹配

---

### 3. **补充题目**

- "副词综合"和"名词综合"题目较少，可能需要补充

---

### 4. **建立数据库索引**

- 根据云开发控制台的建议，建立以下索引：
  - `schoolLevel` (升序)
  - `category` + `schoolLevel` (组合索引)

---

## 🔍 修复文件

- `miniprogram/utils/cloudDataLoader.js`
  - 修复了连词映射表（第296-303行）
  - 修复了父分类映射中的连词相关映射（第429-430行）

---

**修复日期**: 2026-01-20  
**测试数据来源**: 映射验证测试页面 (`miniprogram/pages/test-mapping-verification/index.js`)

---

## 🛠️ 未分类题目处理工具

### 工具1：分析未分类题目 (`analyze_uncategorized_questions.js`)

**功能**: 详细分析309道未分类题目的情况

**使用方法**:
1. 在微信开发者工具中打开项目
2. 在控制台粘贴 `analyze_uncategorized_questions.js` 的代码
3. 运行脚本，查看分析结果

**输出内容**:
- 未分类题目总数
- `grammarPoint`/`tag` 字段分布
- 根据题目内容推断的可能分类
- 示例题目展示
- 处理建议

---

### 工具2：批量修复未分类题目 (`batch_fix_uncategorized_questions.js`)

**功能**: 根据 `grammarPoint`/`tag` 自动分配 `category`

**使用方法**:
1. 在微信开发者工具控制台粘贴脚本代码
2. 先运行模拟模式查看修复计划：
   ```javascript
   batchFixUncategorizedQuestions(true);  // 模拟运行，不修改数据
   ```
3. 确认修复计划无误后，执行实际修复：
   ```javascript
   batchFixUncategorizedQuestions(false);  // 实际执行，会修改数据库
   ```

**修复策略**:
- ✅ **精确匹配**: 使用预定义的映射表直接匹配
- ⚠️ **模糊匹配**: 根据关键词自动推断分类
- ❌ **无法匹配**: 需要人工审核

**特殊分类映射说明**:

#### 1. 谓语(1)到(9)的映射
根据代码中的定义，谓语(1)到(9)直接映射到对应的category：
- `谓语(1)` → `谓语(1)` (一般现在时)
- `谓语(2)` → `谓语(2)` (一般过去时)
- `谓语(3)` → `谓语(3)` (一般将来时)
- `谓语(4)` → `谓语(4)` (过去将来时)
- `谓语(5)` → `谓语(5)` (现在进行时)
- `谓语(6)` → `谓语(6)` (过去进行时)
- `谓语(7)` → `谓语(7)` (现在完成时)
- `谓语(8)` → `谓语(8)` (过去完成时)
- `谓语(9)` → `谓语(9)` (被动语态)

**注意**: 这些category在数据库中都是独立存在的，可以直接使用。

#### 2. 特殊分类映射
根据分析结果，以下grammarPoint需要特殊处理：

| grammarPoint | 映射到的category | 说明 |
|------------|----------------|------|
| `介词 + 名词/动名词` | `介词 + 名词/动名词` | 直接映射，数据库中存在此category |
| `副词修饰句子` | `副词修饰句子` | 直接映射，数据库中存在此category |
| `f/fe结尾` | `f/fe结尾` | 直接映射，数据库中的category就是"f/fe结尾" |
| `固定搭配` | `固定搭配` | 直接映射 |

#### 3. 映射验证
运行 `verify_categories.js` 可以验证这些category是否在数据库中存在：
```javascript
// 在微信开发者工具控制台运行
// 验证需要映射的category是否存在
```

**注意事项**:
- ⚠️ 执行实际修复前，建议先备份数据库
- ⚠️ 建议在测试环境先验证修复逻辑
- ✅ 脚本会显示详细的修复计划和统计信息
- ✅ 建议先运行 `verify_categories.js` 验证category是否存在

---

## 📊 处理进度跟踪

- [ ] 运行分析脚本，了解未分类题目详情
- [ ] 运行 `verify_categories.js` 验证category是否存在
- [ ] 运行批量修复脚本（模拟模式）
- [ ] 审核无法自动匹配的题目
- [ ] 执行批量修复（实际模式）
- [ ] 验证修复结果
- [ ] 验证选题逻辑兼容性（见下方说明）
- [ ] 处理剩余无法分类的题目（人工审核或创建"其他"分类）

---

## ✅ 验证映射逻辑与选题逻辑兼容性

### 验证步骤

1. **验证category存在性**
   ```javascript
   // 运行 verify_categories.js
   // 确保所有需要映射的category在数据库中都存在
   ```

2. **验证选题逻辑**
   修复后，选题逻辑会通过以下方式查询题目：
   - 使用 `cloudDataLoader.getQuestionsByGrammarPoint()` 查询
   - 根据 `category` 字段进行精确匹配
   - 支持专题到子知识点的映射（如"副词"专题包含"副词修饰句子"）

3. **测试关键映射**
   验证以下关键映射是否能正确查询到题目：
   - `谓语(1)` 到 `谓语(6)` → 应该能查询到对应题目
   - `介词 + 名词/动名词` → 应该能在"介词"专题中查询到
   - `副词修饰句子` → 应该能在"副词"专题中查询到
   - `以f/fe结尾` → 应该能在"名词"专题中查询到

4. **验证专题查询**
   在界面上测试以下专题是否能正常选题：
   - 时态/谓语专题 → 应该能包含谓语(1)到(6)的题目
   - 介词专题 → 应该能包含"介词 + 名词/动名词"的题目
   - 副词专题 → 应该能包含"副词修饰句子"的题目
   - 名词专题 → 应该能包含"以f/fe结尾"的题目

### 预期结果

修复完成后：
- ✅ 所有309道未分类题目都有正确的category
- ✅ 选题逻辑能通过category正确查询到题目
- ✅ 专题查询能包含所有相关的子分类题目
- ✅ 前端界面能正常显示和选择这些语法点
