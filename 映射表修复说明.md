# 映射表修复说明

## 问题分析

从测试日志发现，10个语法点中有3个找不到题目：

| 语法点 | 状态 | 原因 |
|-------|------|------|
| 固定搭配 | ✅ 找到3题 | 云数据库有该分类 |
| 代词综合 | ✅ 找到20题 | 云数据库有该分类 |
| 从属连词综合 | ✅ 找到20题 | 云数据库有该分类 |
| 泛指与特指 | ✅ 找到20题 | 云数据库有该分类 |
| **不规则复数** | ❌ 找到0题 | 映射表未包含或映射错误 |
| 主从句与动词 | ✅ 找到20题 | 云数据库有该分类 |
| **时态(过去完成时)** | ❌ 找到0题 | 映射表未包含 |
| 现在分词综合 | ✅ 找到20题 | 云数据库有该分类 |
| 形容词综合 | ✅ 找到20题 | 云数据库有该分类 |
| **副词修饰句子** | ❌ 找到0题 | 映射表未包含 |

## 已实施的修复

### 1. 集成映射表到 cloudDataLoader.js

**修改前**:
```javascript
// 直接查询云数据库，不使用映射表
const result = await wx.cloud.database()
  .collection('questions')
  .where({ category: grammarPoint })
  .get();
```

**修改后**:
```javascript
// ✅ 使用映射表查找多个相关分类
const questionMapping = require('./questionMapping.js');
const mappedCategories = questionMapping.grammarPointToCategories[grammarPoint] || [grammarPoint];

// 从所有映射的分类中获取题目
for (const category of mappedCategories) {
  const result = await wx.cloud.database()
    .collection('questions')
    .where({ category: category })
    .get();
  // ...
}
```

### 2. 补充缺失的映射

**添加的映射**:

```javascript
"时态(过去完成时)": ["时态综合", "谓语(2)", "谓语"],
"副词修饰句子": ["副词综合", "副词(1)", "副词"],
"从属连词综合": ["连词综合", "连词(4)", "连词(5)", "连词"],
```

**优化的映射**:

```javascript
// 不规则复数：添加兜底策略
"不规则复数": ["名词综合", "名词(3)", "名词(4)", "名词"],
```

### 3. 查询逻辑改进

**新的查询流程**:
1. 查找映射表中的所有相关分类
2. 依次查询每个分类
3. 合并所有结果
4. 如果仍然没有结果，使用关键词筛选

**日志示例**:
```
根据语法点获取题目: 不规则复数
   映射分类: ["名词综合", "名词(3)", "名词(4)", "名词"]
   从 "名词综合" 找到 20 题
   从 "名词(3)" 找到 15 题
✅ 总共找到 35 道 不规则复数 题目
```

## 测试验证

### 重新测试步骤

1. **发布新作业**
2. **观察控制台日志**

**预期改进**:

**之前**:
```
⚠️ 语法点 "不规则复数" 未找到题目  (0题)
⚠️ 语法点 "时态(过去完成时)" 未找到题目  (0题)
⚠️ 语法点 "副词修饰句子" 未找到题目  (0题)
✅ 共获取 7 道题目
```

**之后**:
```
✅ 语法点 "不规则复数" 获取 1/1 题  (使用映射表)
✅ 语法点 "时态(过去完成时)" 获取 1/1 题  (使用映射表)
✅ 语法点 "副词修饰句子" 获取 1/1 题  (使用映射表)
✅ 共获取 10 道题目  (全部找到!)
```

## 如果仍然找不到

### 调试脚本

运行 `check_cloud_categories.js` 检查云数据库中的实际分类名称：

```javascript
// 在控制台运行
```

这会显示：
1. 云数据库中所有的分类名称
2. 每个分类的题目数量
3. 建议的映射关系

### 手动调整映射表

如果云数据库中的分类名称与预期不同，可以手动修改 `questionMapping.js`：

```javascript
// 例如：如果云数据库中是"不规则名词复数"而不是"名词综合"
"不规则复数": ["不规则名词复数", "名词综合", "名词"],
```

## 注意事项

1. **不要删除原有映射** - 保持向后兼容
2. **只添加新映射** - 补充缺失的语法点
3. **保留兜底策略** - 最后一项总是大类（如"名词"、"谓语"）
4. **测试后再提交** - 确保映射正确

## 下一步

1. ✅ 重新发布作业，测试题目获取
2. ✅ 如果全部找到（10/10题），继续测试变式题
3. ✅ 如果仍有缺失，运行 `check_cloud_categories.js` 调试

---

**现在请重新发布作业，查看是否所有10个语法点都能找到题目！**
