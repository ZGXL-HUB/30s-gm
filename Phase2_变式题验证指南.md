# Phase 2 变式题验证指南

## ✅ 已完成的修改

### 1. 创建映射表文件
- **文件**: `miniprogram/utils/questionMapping.js`
- **内容**: 语法点 ↔ 云数据库分类的双向映射
- **用途**: 根据原题的语法点查找相关的所有题目分类

### 2. 实现变式题查找方法
- **方法**: `getVariantQuestions(originalQuestion, count)`
- **功能**: 
  - 根据原题的语法点查找映射分类
  - 从云数据库获取相关题目
  - 过滤掉原题
  - 随机选择2个变式题

### 3. 更新学案生成逻辑
- **修改**: `generateLocalWordContent()` 改为异步函数
- **修改**: `downloadMaterialLocally()` 改为异步函数
- **新增**: 为每个原题查找并显示变式题

## 📋 验证步骤

### Step 1: 发布新作业

1. 打开教师布置作业页面
2. 选择作业类型（建议用**专题模式**，语法点少，测试更清晰）
3. 选择2-3个语法点（如"it相关"、"名词综合"）
4. 发布作业

**预期日志**:
```
📚 开始从云数据库获取题目...
✅ 语法点 "it相关" 获取 2/2 题
✅ 语法点 "名词综合" 获取 2/2 题
✅ 共获取 4 道题目
✅ 作业数据包含题目数量: 4
```

### Step 2: 生成学案并查看日志

1. 进入配套材料界面
2. 点击"作业原题学案"按钮
3. **观察控制台日志**（重点！）

**预期日志**:
```
生成Word内容，作业数据: {...}
✅ 使用作业中保存的题目，数量: 4
🔍 开始加载变式题...
🔍 查找 "it相关" 的变式题...
   映射分类: ["it相关", "代词(3)", "代词综合"]
   从 "it相关" 获取 20 题
   从 "代词(3)" 获取 15 题
   过滤后剩余 35 题
   ✅ 最终选择 2 个变式题
🔍 查找 "名词综合" 的变式题...
   映射分类: ["名词综合", "名词(1)", "名词(2)", ...]
   从 "名词综合" 获取 20 题
   过滤后剩余 19 题
   ✅ 最终选择 2 个变式题
...
✅ 共加载 8 个变式题
```

### Step 3: 查看学案内容

**预期格式**:

```markdown
### 练习内容

#### 练习1：it相关
**知识点**: it相关
**题目**: __ was in the park that I met my old friend.

**答案**: It
**解析**: 该句为强调句型"It was + 被强调部分 + that + 其他成分"...

#### 练习2：名词综合
**知识点**: 名词综合
**题目**: My ____ (foot) hurt.

**答案**: feet
**解析**: 该句中需填入名词"foot"的复数形式"feet"...

## 变式练习题

#### 变式题1-1：it相关
**题目**: __ is important to learn English well.

**答案**: It
**解析**: 本题考查it作形式主语的用法...

#### 变式题1-2：it相关
**题目**: I find __ difficult to understand this passage.

**答案**: it
**解析**: 本题考查it作形式宾语的用法...

#### 变式题2-1：名词综合
**题目**: The ____ (child) are playing in the garden.

**答案**: children
**解析**: child的复数形式是不规则变化children...

#### 变式题2-2：名词综合
**题目**: There are many ____ (sheep) on the farm.

**答案**: sheep
**解析**: sheep的单复数形式相同...
```

## ✅ 成功标志

1. **控制台显示变式题查找日志** ✓
2. **每个原题都有2个变式题** ✓
3. **变式题是不同的题目**（不是原题） ✓
4. **变式题保持填空题格式** ✓
5. **没有错误或警告** ✓

## ⚠️ 可能的问题和解决方案

### 问题1: 某些语法点找不到变式题

**症状**:
```
🔍 查找 "XXX" 的变式题...
   映射分类: ["XXX"]
   从 "XXX" 获取 0 题
   过滤后剩余 0 题
   ✅ 最终选择 0 个变式题
原题1 "XXX" 未找到变式题
```

**原因**: 
- 映射表中没有该语法点的映射
- 云数据库中该分类题目较少
- 语法点命名不匹配

**解决方案**:
1. 检查映射表是否包含该语法点
2. 添加更多映射分类作为兜底
3. 使用相近语法点的题目

### 问题2: 变式题加载较慢

**症状**: 点击生成学案后等待时间较长

**原因**: 需要为每个原题异步查询云数据库

**解决方案**:
```javascript
// 优化：使用 Promise.all 并行加载
const variantPromises = assignment.questions.map(q => this.getVariantQuestions(q, 2));
const allVariants = await Promise.all(variantPromises);
```

### 问题3: 云数据库连接失败

**症状**: 所有变式题都显示"未找到"

**解决方案**:
- 检查云开发配置
- 降级显示提示信息："（变式题加载失败，请检查网络连接）"

## 📊 预期改进对比

### Phase 1（原题显示）
```
### 练习内容
（8道原题）

## 变式练习题
（变式练习题将在后续版本中添加）
```

### Phase 2（完整学案）
```
### 练习内容
（8道原题）

## 变式练习题
（16道变式题，每个原题2个变式）
```

## 性能数据估算

### 单次生成学案的数据量

**原题**: 8题 × 1查询 = 已缓存（0次查询）
**变式题**: 8题 × 2变式 = 16题

**云数据库查询次数**:
- 最多: 8个语法点 × 平均3个映射分类 = 24次查询
- 实际: 会去重和缓存，约10-15次查询
- 时间: 每次约100-200ms，总计约2-3秒

**优化后**:
- 批量查询: 减少到5-8次查询
- 缓存: 相同语法点只查询一次
- 时间: 约1-2秒

## 下一步优化（Phase 3）

如果 Phase 2 测试成功，Phase 3 将进行：

1. **性能优化**: 批量加载、缓存机制
2. **映射表完善**: 补充缺失的语法点映射
3. **用户体验**: 添加加载进度提示
4. **降级策略**: 更完善的失败处理

---

**立即测试 Phase 2！** 请发布新作业并生成学案，查看变式题是否正确显示！🚀
