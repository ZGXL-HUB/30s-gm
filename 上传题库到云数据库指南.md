# 上传题库到云数据库指南

## 问题总结

### 当前状况
- ✅ **本地备份**: 1993题完整数据（1.4MB）
- ❌ **云数据库**: 只有20题
- ❌ **miniprogram包**: 已经2.67MB（超过1.5MB限制）

### 解决方案
**使用云数据库存储题目**，不占用小程序包大小

## 🚀 实施步骤

### 步骤1: 部署云函数

在PowerShell中运行：

```powershell
cd cloudfunctions/uploadQuestions
npm install
cd ../..
```

然后在微信开发者工具中：
1. 右键点击 `cloudfunctions/uploadQuestions` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成

### 步骤2: 运行上传脚本

在微信开发者工具控制台中：

```javascript
// 方式1: 复制粘贴 call_upload_questions.js 的全部内容到控制台

// 然后运行：
uploadViaCloudFunction()
```

**预期输出**:
```
=== 上传题库到云数据库 ===
📚 准备上传数据:
   题目总数: 1993
   分类数: 66

📤 使用云函数分批上传...
上传第 1/40 批（1-50）...
✅ 成功上传 50 题
上传第 2/40 批（51-100）...
✅ 成功上传 50 题
...
🎉 上传完成！成功 1993/1993 题
✅ 云数据库当前题目数: 1993
```

### 步骤3: 验证数据

在控制台运行：

```javascript
// 检查题目总数
wx.cloud.callFunction({
  name: 'uploadQuestions',
  data: { action: 'count' }
}).then(res => {
  console.log('题目总数:', res.result.count);
});

// 检查分类
wx.cloud.database()
  .collection('questions')
  .field({ category: true })
  .get()
  .then(res => {
    const categories = [...new Set(res.data.map(q => q.category))];
    console.log('分类数:', categories.length);
    console.log('分类列表:', categories.slice(0, 10));
  });
```

### 步骤4: 测试功能

1. **发布新作业** - 应该能找到所有10个语法点的题目
2. **生成学案** - 应该显示完整的原题和变式题

## 📊 预期改进

### 之前（云数据库只有20题）
```
📚 开始从云数据库获取题目...
⚠️ 语法点 "不规则复数" 未找到题目
⚠️ 语法点 "时态(过去完成时)" 未找到题目
⚠️ 语法点 "副词修饰句子" 未找到题目
✅ 共获取 7 道题目
```

### 之后（云数据库有1993题）
```
📚 开始从云数据库获取题目...
✅ 语法点 "介词综合" 获取 1/1 题
✅ 语法点 "不规则复数" 获取 1/1 题
✅ 语法点 "时态(过去完成时)" 获取 1/1 题
✅ 语法点 "副词修饰句子" 获取 1/1 题
✅ 共获取 10 道题目
```

## ⏱️ 预计时间

- **部署云函数**: 2-3分钟
- **上传1993题**: 5-10分钟（自动分批）
- **验证测试**: 2分钟
- **总计**: 约15分钟

## ⚠️ 注意事项

### 1. 云数据库配额

免费版云数据库：
- 存储空间: 2GB（1993题约2MB，完全够用）
- 读操作: 5万次/天（够用）
- 写操作: 3万次/天（够用）

### 2. 上传时长

- 使用云函数：更稳定，但稍慢（约10分钟）
- 直接上传：更快，但可能被限频（约5分钟）

### 3. 数据备份

上传前建议：
1. 导出当前云数据库（虽然只有20题）
2. 上传后验证数据完整性
3. 保留本地备份文件

## 🎯 上传后的效果

**小程序包大小**: 
- 保持2.67MB（不增加）
- 题目数据在云端，不占用包大小

**功能完整性**:
- ✅ 所有语法点都能找到题目
- ✅ 原题和变式题都正常工作
- ✅ 无需映射表（命名已统一）

**性能**:
- 首次加载: 从云端获取（约1-2秒）
- 后续使用: 从缓存读取（即时）

## 📋 执行清单

- [ ] 部署 uploadQuestions 云函数
- [ ] 在控制台运行 call_upload_questions.js
- [ ] 执行 uploadViaCloudFunction()
- [ ] 等待上传完成（约10分钟）
- [ ] 验证题目总数（应该是1993题）
- [ ] 测试发布作业功能
- [ ] 测试生成学案功能

---

**准备好了就开始部署云函数吧！** 🚀
