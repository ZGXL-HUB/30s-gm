# 映射文件分析报告

## 📋 一、所有映射文件列表

### 1. 核心映射文件（权威数据源）

#### 1.1 `miniprogram/utils/cloudDataLoader.js` ⭐⭐⭐⭐⭐
- **路径**: `miniprogram/utils/cloudDataLoader.js`
- **用途**: **最权威的映射文件**，用于根据语法点从云数据库查询题目
- **特点**:
  - 包含完整的初中模块映射表（middle）和高中模块映射表（high）
  - 支持 `grammarPoint` → `category` 的映射
  - 支持 `grammarPoint` → `grammarPoint` 的精确匹配（初中模块）
  - 包含父分类回退机制
  - 包含关键词匹配机制（模糊匹配兜底）
- **映射结构**:
  - 初中模块: `{ grammarPoint: { category, grammarPoint } }`
  - 高中模块: `{ grammarPoint: category }`
- **使用场景**: 
  - `teacher-generate-material/index.js` 中的 `getQuestionsByGrammarPoint()` 方法
  - 所有需要从数据库查询题目的功能

#### 1.2 `miniprogram/utils/questionMapping.js` ⭐⭐⭐⭐
- **路径**: `miniprogram/utils/questionMapping.js`
- **用途**: 题目分类映射表，用于原题和变式题的查找
- **特点**:
  - 双向映射：`grammarPointToCategories` 和 `categoryToGrammarPoint`
  - 支持一个语法点映射到多个云数据库分类
  - 主要用于变式题查找
- **映射结构**:
  ```javascript
  grammarPointToCategories: {
    "介词": ["介词(1)", "介词(2)", "介词(3)", "介词综合"],
    "连词": ["连词(1)", "连词(2)", "连词(3)", "连词(4)", "连词(5)", "连词(6)", "连词综合"]
  }
  ```
- **使用场景**: 变式题生成、题目分类查找

#### 1.3 `cloudfunctions/grammarCategoryMapping/index.js` ⭐⭐⭐
- **路径**: `cloudfunctions/grammarCategoryMapping/index.js`
- **用途**: 云函数中的语法点分类映射表，用于语法组合功能
- **特点**:
  - 与本地映射表保持一致
  - 支持云函数调用验证
- **映射结构**:
  ```javascript
  CATEGORY_MAPPING = {
    "介词": ["介词综合", "固定搭配", "介词 + 名词/动名词"],
    "连词": ["并列连词综合", "从属连词综合", "连词与名/动/形/副综合", ...]
  }
  ```
- **使用场景**: 语法组合功能的前后端分类映射

### 2. 辅助映射文件

#### 2.1 `miniprogram/pages/teacher/teacher-generate-material/index.js` ⭐
- **路径**: `miniprogram/pages/teacher/teacher-generate-material/index.js` (第228-239行)
- **用途**: 根据语法点获取分类（仅用于占位符题目）
- **特点**:
  - 只包含7个映射，非常有限
  - 仅用于 `getCategoryForGrammarPoint()` 方法
- **映射内容**:
  ```javascript
  categoryMap = {
    'must/need': '情态动词',
    '时间介词': '介词',
    '感叹句': '特殊句式',
    '疑问句': '特殊句式',
    'There be句型': '特殊句式',
    '关系代词': '代词',
    '祈使句': '特殊句式'
  }
  ```
- **问题**: 映射不完整，应该使用 `cloudDataLoader.js` 中的映射

#### 2.2 `miniprogram/pages/teacher/teacher-homework/index.js` ⭐
- **路径**: `miniprogram/pages/teacher/teacher-homework/index.js` (第464-488行)
- **用途**: 根据大点名称生成小点数据（仅用于UI展示）
- **特点**:
  - 只包含3个大点的映射（介词、代词、连词）
  - 不完整，其他大点没有映射
- **映射内容**:
  ```javascript
  pointMappings = {
    '介词': ['介词综合', '固定搭配', '介词 + 名词/动名词'],
    '代词': ['代词综合', '人称代词', '物主代词', '反身代词', '关系代词', 'it相关'],
    '连词': ['并列连词综合', '从属连词综合', '连词与名/动/形/副综合', ...]
  }
  ```
- **问题**: 映射不完整，应该从 `cloudDataLoader.js` 或 `grammarCategoryMapping` 获取

### 3. 数据结构文件

#### 3.1 `miniprogram/pages/teacher/config/middle-school-grammar-data.js` ⭐⭐⭐
- **路径**: `miniprogram/pages/teacher/config/middle-school-grammar-data.js`
- **用途**: 初中英语语法知识点三级菜单数据结构
- **特点**:
  - 包含完整的初中语法知识点树形结构
  - 包含考频、年份等元数据
  - 用于UI展示和专题选择
- **使用场景**: 教师端专题模式选择界面

#### 3.2 `miniprogram/config/middle-school-grammar-data.js` ⭐⭐
- **路径**: `miniprogram/config/middle-school-grammar-data.js`
- **用途**: 与上面文件内容相同（重复文件）
- **问题**: **重复文件，应该删除其中一个**

### 4. 其他文件

#### 4.1 `mapping_template.json` ⭐
- **路径**: `mapping_template.json`
- **用途**: 映射模板文件，用于表格和笔记的映射
- **特点**: 包含表格和笔记的category/subCategory映射
- **使用场景**: 书写练习表格和笔记的映射

#### 4.2 `验证映射表脚本.js` ⭐
- **路径**: `验证映射表脚本.js`
- **用途**: 验证初高中自选模块映射表的脚本
- **特点**: 包含完整的初中和高中映射表定义（用于验证）
- **使用场景**: 开发时验证映射表是否正确

---

## 🎯 二、核心映射识别

### 最权威的映射文件：`miniprogram/utils/cloudDataLoader.js`

**为什么它是权威的？**
1. ✅ 包含最完整的映射关系（初中+高中）
2. ✅ 被 `teacher-generate-material/index.js` 直接使用
3. ✅ 支持精确匹配和模糊匹配
4. ✅ 包含父分类回退机制
5. ✅ 是实际查询数据库时使用的映射

### 应该被 `teacher-generate-material/index.js` 中'专题20题'功能使用的映射

**推荐使用**: `miniprogram/utils/cloudDataLoader.js` 中的映射表

**原因**:
- `teacher-generate-material/index.js` 已经通过 `cloudDataLoader.getQuestionsByGrammarPoint()` 使用该映射
- 该映射支持初中和高中两个学段
- 包含完整的语法点映射关系

---

## ⚠️ 三、冲突检查

### 3.1 "连词"映射冲突

| 文件 | 映射内容 |
|------|---------|
| `cloudDataLoader.js` (高中) | `"连词综合": "连词综合"`<br>`"连词与名词": "连词综合"`<br>`"连词与动词": "连词综合"`<br>`"连词与形容词": "连词综合"` |
| `questionMapping.js` | `"连词": ["连词(1)", "连词(2)", "连词(3)", "连词(4)", "连词(5)", "连词(6)", "连词综合"]`<br>`"连词综合": ["连词综合", "连词(1)", "连词(2)", ...]` |
| `grammarCategoryMapping/index.js` | `"连词": ["并列连词综合", "从属连词综合", "连词与名/动/形/副综合", "连词与名词", "连词与动词", "连词与形容词"]` |
| `teacher-homework/index.js` | `"连词": ["并列连词综合", "从属连词综合", "连词与名/动/形/副综合", "连词与名词", "连词与动词", "连词与形容词"]` |

**冲突分析**:
- `cloudDataLoader.js` 使用 `"连词综合"` 作为目标分类
- `grammarCategoryMapping` 和 `teacher-homework` 使用 `"并列连词综合"`、`"从属连词综合"` 等
- `questionMapping.js` 使用 `"连词(1)"`、`"连词(2)"` 等编号格式

**建议**: 以 `cloudDataLoader.js` 为准，因为它是实际查询数据库时使用的映射。

### 3.2 "代词"映射冲突

| 文件 | 映射内容 |
|------|---------|
| `cloudDataLoader.js` (初中) | `"人称代词": { category: "代词", grammarPoint: "人称代词" }`<br>`"物主代词": { category: "代词", grammarPoint: "物主代词" }` |
| `cloudDataLoader.js` (高中) | `"关系代词": "关系代词"`<br>`"反身代词": "反身代词"`<br>`"人称代词": "人称代词"` |
| `questionMapping.js` | `"代词": ["代词(1)", "代词(2)", "代词(3)", "代词(4)", "代词(5)", "代词(6)", "代词综合"]` |
| `grammarCategoryMapping/index.js` | `"代词": ["代词综合", "人称代词", "物主代词", "反身代词", "关系代词", "it相关"]` |

**冲突分析**:
- 初中模块使用 `"代词"` 作为category
- 高中模块使用具体的语法点名称作为category
- `questionMapping.js` 使用编号格式

**建议**: 以 `cloudDataLoader.js` 为准，根据学段（schoolLevel）选择对应的映射。

### 3.3 其他冲突

- **"介词"**: 各文件基本一致，都使用 `"介词综合"` 或 `"介词(1)"` 等格式
- **"冠词"**: 各文件基本一致
- **"名词"**: 初中模块使用 `"名词"`，高中模块使用 `"名词综合"` 或具体子分类

---

## 🧹 四、清理建议

### 4.1 可以安全删除的文件

#### ❌ `miniprogram/config/middle-school-grammar-data.js`
- **原因**: 与 `miniprogram/pages/teacher/config/middle-school-grammar-data.js` 内容完全相同
- **建议**: 删除此文件，保留 `miniprogram/pages/teacher/config/middle-school-grammar-data.js`

#### ❌ `miniprogram/pages/teacher/teacher-generate-material/index.js` 中的 `categoryMap` (第228-239行)
- **原因**: 映射不完整，只有7个映射，应该使用 `cloudDataLoader.js` 中的映射
- **建议**: 删除此映射，改用 `cloudDataLoader.js` 的映射逻辑

#### ❌ `miniprogram/pages/teacher/teacher-homework/index.js` 中的 `pointMappings` (第464-488行)
- **原因**: 映射不完整，只有3个大点，应该从 `cloudDataLoader.js` 或 `grammarCategoryMapping` 获取
- **建议**: 删除此映射，改用统一的映射源

### 4.2 可以合并的文件

#### 🔄 `questionMapping.js` 和 `cloudDataLoader.js`
- **现状**: 两个文件都包含映射关系，但用途不同
- **建议**: 
  - 保持现状（因为用途不同）
  - 但需要确保映射一致性
  - 建议从 `cloudDataLoader.js` 导出映射，供 `questionMapping.js` 使用

#### 🔄 `grammarCategoryMapping/index.js` 和 `cloudDataLoader.js`
- **现状**: 云函数中的映射与本地映射需要保持一致
- **建议**: 
  - 保持现状（因为一个是云函数，一个是本地文件）
  - 但需要建立同步机制，确保一致性

### 4.3 需要统一的地方

#### ✅ 统一映射源
- **建议**: 所有映射都应该从 `cloudDataLoader.js` 获取
- **实现**: 
  1. 在 `cloudDataLoader.js` 中导出映射表
  2. 其他文件导入并使用该映射表
  3. 删除重复的映射定义

#### ✅ 统一命名规范
- **问题**: 不同文件使用不同的命名格式（如 `"连词(1)"` vs `"连词综合"`）
- **建议**: 统一使用 `cloudDataLoader.js` 中的命名规范

---

## 📊 五、总结

### 核心映射文件优先级

1. **⭐⭐⭐⭐⭐ `miniprogram/utils/cloudDataLoader.js`** - 最权威，应该作为主要数据源
2. **⭐⭐⭐⭐ `miniprogram/utils/questionMapping.js`** - 用于变式题查找，需要与 cloudDataLoader 保持一致
3. **⭐⭐⭐ `cloudfunctions/grammarCategoryMapping/index.js`** - 云函数映射，需要与本地保持一致
4. **⭐⭐⭐ `miniprogram/pages/teacher/config/middle-school-grammar-data.js`** - 数据结构文件，用于UI展示

### 清理优先级

1. **高优先级**: 删除重复文件 `miniprogram/config/middle-school-grammar-data.js`
2. **中优先级**: 删除 `teacher-generate-material/index.js` 中的不完整映射
3. **中优先级**: 删除 `teacher-homework/index.js` 中的不完整映射
4. **低优先级**: 统一映射源，建立映射同步机制

### 建议的改进方案

1. **建立统一的映射管理模块**
   - 在 `cloudDataLoader.js` 中集中管理所有映射
   - 其他文件从该模块导入映射

2. **建立映射验证机制**
   - 使用 `验证映射表脚本.js` 定期验证映射一致性
   - 在CI/CD中集成验证

3. **文档化映射关系**
   - 为每个映射文件添加清晰的注释
   - 说明映射的用途和使用场景
