# 云开发问题解决方案

## 常见错误码说明

### ❌ 错误码 -601002
**错误描述：** 云开发环境访问失败  
**常见原因：**
1. 云开发环境ID无效或不存在
2. 小程序没有该环境的访问权限
3. 云开发服务状态异常
4. 网络连接问题

### ❌ 错误码 -601005  
**错误描述：** 云函数不存在  
**常见原因：**
1. 云函数未部署
2. 函数名称错误
3. 云函数部署失败

## 系统性解决方案

### 🔧 第1步：检查云开发环境

**在微信开发者工具中：**
1. 点击工具栏的"云开发"按钮
2. 检查是否有环境列表显示
3. 确认环境ID是否正确：`cloud1-4gyu3i1id5f4e2fa`
4. 检查环境状态是否为"正常"

**如果没有环境：**
- 创建新的云开发环境
- 记录新的环境ID
- 更新 `miniprogram/app.js` 中的环境ID

### 🔧 第2步：检查项目配置

**确认以下配置：**
- `project.config.json` 中的 `appid` 正确
- `miniprogram/app.js` 中的环境ID正确
- 基础库版本 >= 2.2.3（当前：3.8.5 ✅）

### 🔧 第3步：部署云函数

**必须部署的云函数：**
1. `login` - 用于用户认证
2. `initializeQuestions` - 初始化题目数据
3. `manageQuestions` - 管理题目
4. `adminAuth` - 管理员权限
5. `importExportQuestions` - 导入导出题目
6. `quickstartFunctions` - 快速开始功能

**部署方法：**
```bash
# 对于每个云函数，执行以下操作：
# 1. 右键点击 cloudfunctions/[函数名] 文件夹
# 2. 选择 "上传并部署：云端安装依赖"
# 3. 等待部署完成
```

### 🔧 第4步：检查数据库权限

**在云开发控制台中：**
1. 进入"数据库"
2. 检查 `questions` 集合是否存在
3. **重要：确认数据库权限设置正确**

**正确的权限设置：**
```
✅ 推荐设置：所有用户可读，仅创建者可写
❌ 错误设置：所有用户读取，仅创建者可读写（这会导致-601002错误）
```

**修改权限的步骤：**
1. 在云开发控制台点击"数据库"
2. 点击 `questions` 集合
3. 点击右上角的"索引管理"旁边的设置图标
4. 选择"所有用户可读，仅创建者可写"
5. 保存设置

**权限说明：**
- **所有用户可读**：允许小程序读取题目数据
- **仅创建者可写**：只有管理员可以修改题目数据
- **这个设置可以解决大部分-601002权限错误**

### 🔧 第5步：使用诊断工具

**在小程序测试页面：**
1. 点击"检查云开发环境"
2. 点击"测试云数据库连接"
3. 根据错误提示进行修复

## 🚨 紧急修复方案

### 如果云开发环境完全不可用：

1. **重新初始化云开发：**
   ```javascript
   // 在 miniprogram/app.js 中
   wx.cloud.init({
     traceUser: true,
     // 暂时不指定环境ID，让系统自动选择
   });
   ```

2. **使用默认环境：**
   - 注释掉 `env` 参数
   - 让系统自动选择可用环境
   - 重新部署云函数

3. **降级到本地数据：**
   - 题目会从本地文件加载
   - 功能受限但可基本使用

## 📊 问题排查检查清单

- [ ] 云开发环境是否存在且正常
- [ ] 环境ID是否正确配置
- [ ] 所有必要的云函数是否已部署
- [ ] 数据库权限是否正确设置
- [ ] 网络连接是否正常
- [ ] 微信开发者工具版本是否最新
- [ ] 基础库版本是否支持云开发

## 🔄 完整重置流程

**如果所有方法都失败，执行完整重置：**

1. **删除现有环境（如果有）**
2. **创建新的云开发环境**
3. **更新环境ID配置**
4. **重新部署所有云函数**
5. **初始化数据库**
6. **测试连接**

## 📞 获取帮助

如果问题仍然存在，请提供：
1. 错误代码和完整错误信息
2. 云开发控制台截图
3. 微信开发者工具版本
4. 操作系统版本

---

**最后更新：** 2024年1月  
**适用版本：** 微信小程序云开发 3.8.5+ 