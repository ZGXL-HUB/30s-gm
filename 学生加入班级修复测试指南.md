# 学生加入班级修复测试指南

## 测试前准备

### 1. 部署云函数
首先需要部署修复后的云函数。有两种方式：

#### 方式A：使用PowerShell脚本（推荐）
```powershell
.\deploy_student_join_fix.ps1
```

#### 方式B：手动部署
1. 打开微信开发者工具
2. 点击"云开发"按钮
3. 在云开发控制台中，找到并部署以下云函数：
   - `studentJoinClass` - 右键 → "上传并部署：云端安装依赖"
   - `manageClassInvite` - 右键 → "上传并部署：云端安装依赖"
4. 等待部署完成（约1-2分钟）

### 2. 确认环境
- 确保云开发环境已初始化
- 确保有教师账号（用于创建班级和邀请码）
- 确保有测试用的学生账号（或使用开发者工具的测试号）

## 测试步骤

### 测试一：自动化测试（控制台脚本）

#### 步骤1：准备测试环境
1. 在微信开发者工具中打开项目
2. 以教师身份登录（如果还没有教师账号，先创建一个）
3. 确保教师账号下有至少一个活跃的班级

#### 步骤2：运行测试脚本
1. 打开开发者工具的"控制台"标签
2. 复制`test_student_join_class_fix.js`文件的全部内容
3. 粘贴到控制台并按回车执行
4. 观察控制台输出

#### 步骤3：查看测试结果
测试脚本会自动执行以下操作：
- ✓ 获取教师信息
- ✓ 查找教师的班级
- ✓ 生成或使用现有邀请码
- ✓ 验证邀请码
- ✓ 创建测试学生并加入班级
- ✓ 验证学生记录是否正确创建
- ✓ 验证班级人数是否正确更新
- ✓ 验证数据是否同步一致

**预期结果**：
```
===== 测试完成 =====
总结:
✓ 邀请码验证正常
✓ 学生记录创建成功
✓ 学生信息完整
✓ 班级人数更新正常
✓ 数据同步一致
```

### 测试二：手动测试（真实流程）

#### 测试场景1：新学生通过邀请码加入班级

##### 教师端操作
1. 以教师身份登录小程序
2. 进入"班级管理"
3. 选择一个班级
4. 点击"生成邀请码"或查看现有邀请码
5. 记录邀请码（6位数字）
6. 记录当前班级人数

##### 学生端操作
1. 切换到学生身份（或使用另一个测试账号）
2. 进入"加入班级"页面
3. 输入教师提供的6位邀请码
4. 点击"验证邀请码"

**验证点1：班级信息显示**
- [ ] 显示正确的班级名称
- [ ] 显示正确的教师姓名
- [ ] **显示的学生人数与实际人数一致**
- [ ] 显示剩余名额

5. 如果没有姓名，系统会提示输入姓名
6. 输入学生姓名（例如："张三"）
7. 点击"确认加入班级"

**验证点2：加入成功**
- [ ] 显示"成功加入班级"的提示
- [ ] 可以进入学生中心

##### 数据库验证
1. 打开云开发控制台
2. 进入"数据库"标签
3. 查看`students`集合

**验证点3：学生记录**
- [ ] 存在新创建的学生记录
- [ ] `openId`字段有值
- [ ] `name`字段为输入的姓名
- [ ] `classId`字段为目标班级ID
- [ ] `className`字段为目标班级名称
- [ ] `teacherId`字段为教师ID
- [ ] `joinMethod`字段为`'invite'`
- [ ] `status`字段为`'active'`

4. 查看`classes`集合，找到对应的班级

**验证点4：班级人数**
- [ ] `currentStudents`字段已增加1
- [ ] 与实际students集合中的学生数一致

##### 再次验证邀请码
1. 学生端再次输入相同的邀请码
2. 验证邀请码

**验证点5：人数更新**
- [ ] 显示的学生人数已增加
- [ ] 剩余名额已减少

#### 测试场景2：学生姓名验证

##### 学生端操作
1. 清除本地存储的学生信息：
   ```javascript
   wx.removeStorageSync('studentInfo')
   ```
2. 重新进入"加入班级"页面
3. 输入有效的邀请码
4. 验证邀请码成功
5. **不输入姓名**，直接点击"确认加入班级"

**验证点6：姓名验证**
- [ ] 系统提示"请输入您的姓名"
- [ ] 显示姓名输入框
- [ ] 无法继续加入班级流程

6. 输入姓名后再次尝试

**验证点7：加入成功**
- [ ] 能够成功加入班级
- [ ] 学生记录包含姓名

#### 测试场景3：重复加入同一班级

##### 学生端操作
1. 使用已加入班级的学生账号
2. 再次输入同一个班级的邀请码
3. 点击"确认加入班级"

**验证点8：重复加入提示**
- [ ] 系统提示"您已经在此班级中"
- [ ] 班级人数没有重复增加

## 云函数日志检查

### 查看日志的方法
1. 打开微信开发者工具
2. 点击"云开发"
3. 选择"云函数"标签
4. 点击对应的云函数名称
5. 查看"日志"标签

### studentJoinClass 云函数日志

应该包含以下日志：
```
开始处理学生加入班级请求
邀请码: 123456
学生信息: {"openId":"...","name":"张三","avatarUrl":""}
邀请码验证成功，班级信息: {...}
查询到的学生记录数: 0
创建新学生记录
学生记录创建成功，ID: ...
更新班级学生数量
班级学生数量更新结果: {...}
学生加入班级流程完成
```

### manageClassInvite 云函数日志

应该包含以下日志：
```
验证邀请码: 123456
找到班级: xxx班 ID: ...
班级当前学生数（实时统计）: 5
classes集合记录的学生数: 5
邀请码验证成功
```

如果发现数量不一致：
```
学生数量不一致，更新classes集合
```

## 常见问题排查

### 问题1：学生记录未创建
**症状**：加入成功，但students集合中没有记录

**排查步骤**：
1. 检查云函数日志，查找错误信息
2. 确认`studentInfo.openId`是否为空
3. 确认`studentInfo.name`是否为空
4. 检查是否有权限问题

**解决方法**：
- 确保login云函数正常工作
- 确保学生已输入姓名
- 检查云数据库权限设置

### 问题2：班级人数显示不正确
**症状**：显示的人数与实际不符

**排查步骤**：
1. 查看云函数日志，对比实时统计和classes集合的值
2. 手动统计students集合中status为'active'的学生数
3. 检查classes集合的currentStudents字段

**解决方法**：
- 云函数会自动同步，等待下次验证邀请码时更新
- 或手动更新classes集合的currentStudents字段

### 问题3：重复学生记录
**症状**：同一个学生有多条记录

**排查步骤**：
1. 检查students集合，按openId搜索
2. 查看这些记录的创建时间
3. 检查云函数日志

**解决方法**：
- 删除重复的记录，只保留最新的
- 确保云函数的查询逻辑正确

## 测试完成检查清单

- [ ] 云函数部署成功
- [ ] 自动化测试脚本运行通过
- [ ] 新学生可以通过邀请码加入班级
- [ ] 学生记录正确创建在students集合中
- [ ] 学生信息完整（包含openId、name等）
- [ ] 班级人数正确更新
- [ ] 显示的人数与实际一致
- [ ] 姓名验证正常工作
- [ ] 重复加入被正确阻止
- [ ] 云函数日志输出正常
- [ ] 无错误和警告

## 测试后清理（可选）

如果创建了测试数据，可以清理：

### 删除测试学生记录
```javascript
// 在控制台执行
const db = wx.cloud.database();
db.collection('students').where({
  name: db.RegExp({
    regexp: '^测试学生',
    options: 'i'
  })
}).remove().then(res => {
  console.log('删除了', res.removed, '条测试学生记录');
});
```

### 重置班级人数
```javascript
// 在控制台执行（需要替换classId）
const classId = 'your_class_id';
const db = wx.cloud.database();

// 统计实际学生数
db.collection('students').where({
  classId: classId,
  status: 'active'
}).count().then(countRes => {
  // 更新班级人数
  return db.collection('classes').doc(classId).update({
    data: {
      currentStudents: countRes.total
    }
  });
}).then(() => {
  console.log('班级人数已重置');
});
```

## 总结

完成以上测试后，如果所有验证点都通过，说明修复成功，学生加入班级的数据同步问题已解决。

