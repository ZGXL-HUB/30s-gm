<!--é‡æµ‹æˆ‘çš„è¯­æ³•æ°´å¹³é¡µé¢-->
<view class="container">
  <!-- æ¬¢è¿ç•Œé¢ -->
  <view class="welcome-screen" wx:if="{{testState === 'welcome'}}">
    <view class="welcome-content">
      <view class="welcome-title">ğŸ¯ é‡æµ‹æˆ‘çš„è¯­æ³•æ°´å¹³</view>
      <view class="welcome-message">
        äº²çˆ±çš„ç”¨æˆ·ï¼Œç°åœ¨è®©æˆ‘ä»¬é€šè¿‡ä¸¤é“é¢˜é‡æ–°æµ‹ä¸€æµ‹æ‚¨çš„è¯­æ³•æ°´å¹³ï¼Œæˆ‘ä¼šæ ¹æ®æ‚¨çš„æµ‹è¯•ç»“æœç»™å‡ºé’ˆå¯¹æ€§çš„ä½¿ç”¨è¯´æ˜å“¦ï¼
      </view>
      <button class="start-btn" bindtap="startTest">å¼€å§‹æµ‹è¯•</button>
    </view>
  </view>

  <!-- æµ‹è¯•ç•Œé¢ -->
  <view class="test-screen" wx:if="{{testState === 'testing'}}">
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progress}}%"></view>
    </view>
    
    <view class="question-card">
      <view class="question-header">
        <text class="question-number">ç¬¬{{currentQuestionIndex + 1}}é¢˜</text>
        <text class="question-type">è¯­æ³•é€‰æ‹©é¢˜</text>
      </view>
      
      <view class="question-content">
        <text class="question-text">{{currentQuestion.text}}</text>
      </view>
      
      <view class="options-container">
        <view 
          class="option-item {{showAnswer && option === currentQuestion.correctAnswer ? 'correct' : ''}} {{showAnswer && option !== currentQuestion.correctAnswer && userAnswer === option ? 'incorrect' : ''}}"
          wx:for="{{currentQuestion.options}}" 
          wx:key="index"
          wx:for-item="option"
          data-option="{{option}}"
          bindtap="selectOption"
          catchtap="selectOption"
        >
          <text class="option-label">{{index + 1}}</text>
          <text class="option-text">{{option}}</text>
        </view>
      </view>
      
      <!-- è°ƒè¯•ä¿¡æ¯ -->
      <view class="debug-info" wx:if="{{currentQuestion}}">
        <text class="debug-text">å½“å‰é¢˜ç›®: {{currentQuestion.text}}</text>
        <text class="debug-text">é€‰é¡¹æ•°é‡: {{currentQuestion.options.length}}</text>
        <text class="debug-text">ç”¨æˆ·ç­”æ¡ˆ: {{userAnswer}}</text>
        <text class="debug-text">æ­£ç¡®ç­”æ¡ˆ: {{currentQuestion.correctAnswer}}</text>
      </view>
      
      <!-- æµ‹è¯•æŒ‰é’® -->
      <view class="test-buttons" wx:if="{{currentQuestion && currentQuestion.options}}">
        <button class="test-option-btn" bindtap="forceSelectOption" data-option="{{currentQuestion.options[0]}}">é€‰æ‹©A</button>
        <button class="test-option-btn" bindtap="forceSelectOption" data-option="{{currentQuestion.options[1]}}">é€‰æ‹©B</button>
        <button class="test-option-btn" bindtap="forceSelectOption" data-option="{{currentQuestion.options[2]}}">é€‰æ‹©C</button>
      </view>
      
      <view class="answer-feedback" wx:if="{{showAnswer}}">
        <view class="feedback-icon {{isCorrect ? 'correct' : 'incorrect'}}">
          {{isCorrect ? 'âœ“' : 'âœ—'}}
        </view>
        <view class="feedback-text">
          {{isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'æ­£ç¡®ç­”æ¡ˆï¼š' + currentQuestion.correctAnswer}}
        </view>
        <view class="analysis" wx:if="{{currentQuestion.analysis}}">
          {{currentQuestion.analysis}}
        </view>
      </view>
    </view>
  </view>

  <!-- ç»“æœç•Œé¢ -->
  <view class="result-screen" wx:if="{{testState === 'result'}}">
    <view class="result-content">
      <view class="result-title">ğŸ‰ æµ‹è¯•å®Œæˆï¼</view>
      
      <!-- å¾—åˆ†å’Œè¯„çº§ -->
      <view class="result-summary">
        <view class="score-section">
          <view class="score-title">æ‚¨çš„å¾—åˆ†</view>
          <view class="score-value">{{testResults.correctCount}}/{{testResults.totalQuestions}}</view>
          <view class="score-rate">æ­£ç¡®ç‡ï¼š{{testResults.correctRate}}%</view>
        </view>
        
        <view class="level-section">
          <view class="level-title">è¯­æ³•æ°´å¹³è¯„çº§</view>
          <view class="level-value level-{{testResults.level}}">
            {{testResults.level === 'level1' ? 'è¾ƒä¸ºè–„å¼±' : 
              testResults.level === 'level2' ? 'ç¨å¼±' : 
              testResults.level === 'level3' ? 'ä¸é”™å“¦' : 
              testResults.level === 'level4' ? 'è¶…æ£’çš„' : 'ç®€ç›´å®Œç¾'}}
          </view>
        </view>
      </view>
      
      <!-- æ¨èå’Œå»ºè®® -->
      <view class="recommendation-section">
        <view class="recommendation-title">æ¨èæ¨¡å—</view>
        <view class="recommendation-content">{{testResults.recommendation}}</view>
        <view class="suggestion-content">{{testResults.suggestion}}</view>
      </view>
      
      <!-- é‡è¦æç¤ºä¿¡æ¯ -->
      <view class="result-tip">
        å¦‚æœæƒ³è¦é‡æ–°æµ‹è¯•è¯­æ³•èƒ½åŠ›å¯ä»¥ä»'è¿›é˜¶ä¹‹æ—…'æ¨¡å—å†æ¬¡æµ‹è¯•ï¼Œå¸¸æµ‹å¸¸æ–°å“¦~
      </view>
      
      <!-- ä¸‹ä¸€æ­¥æ¨è -->
      <view class="next-steps-section">
        <view class="next-steps-title">ğŸ¯ æ ¹æ®æ‚¨çš„æµ‹è¯•ç»“æœï¼Œæ¨èä¸‹ä¸€æ­¥ï¼š</view>
        <view class="next-steps-list">
          <view class="next-step-item" bindtap="goToRecommendedPractice">
            <view class="step-icon">ğŸ“š</view>
            <view class="step-content">
              <view class="step-title">å¼€å§‹è¯­æ³•ç»ƒä¹ </view>
              <view class="step-desc">æ ¹æ®æ‚¨çš„è–„å¼±ç¯èŠ‚ï¼Œè¿›è¡Œé’ˆå¯¹æ€§ç»ƒä¹ </view>
            </view>
            <view class="step-arrow">></view>
          </view>
          
          <view class="next-step-item" bindtap="goToDailyRecommendation">
            <view class="step-icon">ğŸ¯</view>
            <view class="step-content">
              <view class="step-title">æŸ¥çœ‹æ¯æ—¥æ¨è</view>
              <view class="step-desc">è·å–ä¸ªæ€§åŒ–çš„æ¯æ—¥å­¦ä¹ ä»»åŠ¡</view>
            </view>
            <view class="step-arrow">></view>
          </view>
          
          <view class="next-step-item" bindtap="goToWritingTest">
            <view class="step-icon">âœï¸</view>
            <view class="step-content">
              <view class="step-title">æµ‹è¯•ä¹¦å†™èƒ½åŠ›</view>
              <view class="step-desc">å…¨é¢è¯„ä¼°æ‚¨çš„ä¹¦å†™è§„èŒƒæŒæ¡æƒ…å†µ</view>
            </view>
            <view class="step-arrow">></view>
          </view>
        </view>
      </view>
      
      <!-- åº•éƒ¨ä¸‰ä¸ªæŒ‰é’® -->
      <view class="result-actions">
        <button class="result-btn analysis-btn" bindtap="viewAnalysis">
          <text class="btn-icon">ğŸ“–</text>
          <text class="btn-text">æŸ¥çœ‹è§£æ</text>
        </button>
        <button class="result-btn report-btn" bindtap="viewReport">
          <text class="btn-icon">ğŸ“Š</text>
          <text class="btn-text">æŸ¥çœ‹æŠ¥å‘Š</text>
        </button>
        <button class="result-btn save-btn" bindtap="saveToDailyTask">
          <text class="btn-icon">ğŸ’¾</text>
          <text class="btn-text">ä¿å­˜é”™é¢˜åˆ°æ¯æ—¥ä»»åŠ¡</text>
        </button>
      </view>

      <!-- åé¦ˆå…¥å£ -->
      <view class="feedback-section">
        <view class="feedback-title">æµ‹è¯•ä½“éªŒå¦‚ä½•ï¼Ÿ</view>
        <view class="feedback-desc">æ‚¨çš„åé¦ˆå¸®åŠ©æˆ‘ä»¬ä¸æ–­æ”¹è¿›æµ‹è¯•è´¨é‡</view>
        <button class="feedback-btn" bindtap="goToFeedback" data-type="experience" data-context="grammar_test">
          ğŸ’¬ åé¦ˆæµ‹è¯•ä½“éªŒ
        </button>
      </view>
    </view>
  </view>

  <!-- è§£æç•Œé¢ -->
  <view class="analysis-screen" wx:if="{{showAnalysis}}">
    <view class="analysis-content">
      <view class="analysis-header">
        <view class="analysis-title">ğŸ“– é¢˜ç›®è§£æ</view>
        <view class="close-btn" bindtap="viewReport">Ã—</view>
      </view>
      
      <view class="analysis-list">
        <view wx:for="{{userAnswers}}" wx:key="id" wx:for-item="answer" class="analysis-item">
          <view class="question-header-analysis">
            <text class="question-number-analysis">ç¬¬{{index + 1}}é¢˜</text>
            <text class="question-tag">{{answer.tag}}</text>
          </view>
          
          <view class="question-text-analysis">{{answer.question}}</view>
          
          <view class="answer-details">
            <view class="answer-row">
              <text class="answer-label">æ­£ç¡®ç­”æ¡ˆï¼š</text>
              <text class="answer-correct">{{answer.correctAnswer}}</text>
            </view>
            <view class="answer-row">
              <text class="answer-label">æ‚¨çš„ç­”æ¡ˆï¼š</text>
              <text class="answer-user {{answer.isCorrect ? 'correct' : 'incorrect'}}">{{answer.selectedAnswer}}</text>
            </view>
            <view class="answer-row">
              <text class="answer-label">ç»“æœï¼š</text>
              <text class="answer-result {{answer.isCorrect ? 'correct' : 'incorrect'}}">
                {{answer.isCorrect ? 'âœ“ æ­£ç¡®' : 'âœ— é”™è¯¯'}}
              </text>
            </view>
          </view>
          
          <view class="analysis-content-text" wx:if="{{answer.analysis}}">
            <text class="analysis-label">è§£æï¼š</text>
            <text class="analysis-text">{{answer.analysis}}</text>
          </view>
          
          <view class="question-source">æ¥æºï¼š{{answer.setInfo}}</view>
        </view>
      </view>
    </view>
  </view>

  <!-- æŠ¥å‘Šç•Œé¢ -->
  <view class="report-screen" wx:if="{{showReport}}">
    <view class="report-content">
      <view class="report-header">
        <view class="report-title">ğŸ“Š æµ‹è¯•æŠ¥å‘Š</view>
        <view class="close-btn" bindtap="viewAnalysis">Ã—</view>
      </view>
      
      <view class="report-summary">
        <view class="report-score">
          <view class="report-score-title">æ€»ä½“å¾—åˆ†</view>
          <view class="report-score-value">{{testResults.correctCount}}/{{testResults.totalQuestions}}</view>
          <view class="report-score-rate">æ­£ç¡®ç‡ï¼š{{testResults.correctRate}}%</view>
        </view>
        
        <view class="report-level">
          <view class="report-level-title">è¯­æ³•æ°´å¹³è¯„çº§</view>
          <view class="report-level-value level-{{testResults.level}}">
            {{testResults.level === 'level1' ? 'è¾ƒä¸ºè–„å¼±' : 
              testResults.level === 'level2' ? 'ç¨å¼±' : 
              testResults.level === 'level3' ? 'ä¸é”™å“¦' : 
              testResults.level === 'level4' ? 'è¶…æ£’çš„' : 'ç®€ç›´å®Œç¾'}}
          </view>
        </view>
      </view>
      
      <view class="report-recommendation">
        <view class="report-recommendation-title">æ¨èæ¨¡å—</view>
        <view class="report-recommendation-content">{{testResults.recommendation}}</view>
        <view class="report-suggestion-content">{{testResults.suggestion}}</view>
      </view>
      
      <view class="report-actions">
        <button class="report-action-btn" bindtap="retest">é‡æ–°æµ‹è¯•</button>
        <button class="report-action-btn" bindtap="goHome">è¿”å›é¦–é¡µ</button>
      </view>
    </view>
  </view>
</view>
