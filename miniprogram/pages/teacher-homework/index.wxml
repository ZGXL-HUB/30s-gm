<!--æ•™å¸ˆç«¯å¸ƒç½®è¯­æ³•ä½œä¸šé¡µé¢-->
<view class="teacher-homework">
  <!-- ä½œä¸šç±»å‹é€‰æ‹©å¡ç‰‡å¼¹çª— -->
  <view class="homework-type-selector" wx:if="{{!homeworkType}}">
    <view class="selector-header">
      <text class="title">é€‰æ‹©ä½œä¸šç±»å‹</text>
      <text class="subtitle">è¯·é€‰æ‹©æ‚¨è¦å¸ƒç½®çš„ä½œä¸šç±»å‹</text>
    </view>
    <view class="type-cards">
      <view 
        class="type-card"
        wx:for="{{homeworkTypes}}" 
        wx:key="id"
        data-type="{{item.id}}"
        bindtap="selectHomeworkType"
      >
        <view class="card-icon" style="background: linear-gradient(135deg, {{item.color}} 0%, {{item.color}}CC 100%);">
          <text class="icon">{{item.icon}}</text>
        </view>
        <view class="card-content">
          <text class="title">{{item.title}}</text>
          <text class="subtitle">{{item.subtitle}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç»Ÿä¸€æ–‡ä»¶æ ‘ç•Œé¢ -->
  <view class="homework-content" wx:if="{{homeworkType}}">
    <!-- é¡¶éƒ¨å·²é€‰å†…å®¹æ ‡ç­¾ -->
    <view class="selected-content-header">
      <view class="header-row">
        <text class="header-title">å·²é€‰å†…å®¹</text>
        <!-- ä¹±åºå¼€å…³ -->
        <view class="shuffle-toggle">
          <text class="shuffle-label">ä¹±åºå‡ºé¢˜</text>
          <switch 
            checked="{{shuffleQuestions}}" 
            bindchange="toggleShuffle"
            color="#1890ff"
          />
        </view>
      </view>
      <view class="selected-tags" wx:if="{{homeworkType !== 'gaokao'}}">
        <!-- æ€»é¢˜æ•°æ˜¾ç¤ºå’Œè¿›åº¦æ¡ -->
        <view class="total-questions-section" wx:if="{{selectedTags.length > 0 || selectedTopics.length > 0}}">
          <view class="total-info">
            <text class="total-label">æ€»é¢˜æ•°:</text>
            <text class="total-count">{{totalQuestions}}é¢˜</text>
            <text class="max-count">/ 20é¢˜</text>
          </view>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{(totalQuestions / 20) * 100}}%"></view>
          </view>
        </view>
        
        <!-- ä¸“é¢˜æ¨¡å¼ï¼šæç®€å¿«é€Ÿé€‰æ‹© -->
        <view class="topic-quick-section" wx:if="{{homeworkType === 'topic'}}">
          <!-- æ€»æ•°é€‰æ‹© -->
          <view class="total-questions-selector">
            <text class="selector-title">é€‰æ‹©é¢˜ç›®æ€»æ•°</text>
            <view class="question-count-buttons">
              <view 
                class="count-btn {{selectedTotalCount === 5 ? 'active' : ''}}"
                bindtap="selectTotalCount"
                data-count="5"
              >5é¢˜</view>
              <view 
                class="count-btn {{selectedTotalCount === 10 ? 'active' : ''}}"
                bindtap="selectTotalCount"
                data-count="10"
              >10é¢˜</view>
              <view 
                class="count-btn {{selectedTotalCount === 15 ? 'active' : ''}}"
                bindtap="selectTotalCount"
                data-count="15"
              >15é¢˜</view>
              <view 
                class="count-btn {{selectedTotalCount === 20 ? 'active' : ''}}"
                bindtap="selectTotalCount"
                data-count="20"
              >20é¢˜</view>
            </view>
          </view>
          
          <!-- å·²é€‰ä¸“é¢˜æ˜¾ç¤º -->
          <view class="selected-topics-display" wx:if="{{selectedTopics.length > 0}}">
            <text class="display-title">å·²é€‰ä¸“é¢˜ ({{selectedTopics.length}}ä¸ª)</text>
            <view class="topic-tags">
              <view 
                class="topic-tag"
                wx:for="{{selectedTopics}}" 
                wx:key="*this"
              >
                <text class="topic-tag-text">{{item}}</text>
                <text class="topic-tag-remove" data-topic="{{item}}" bindtap="removeSelectedTopic">Ã—</text>
              </view>
            </view>
          </view>
        </view>
        
        <!-- è‡ªé€‰æ¨¡å¼ï¼šè¯¦ç»†æ§åˆ¶ -->
        <view class="slider-section" wx:if="{{homeworkType === 'custom' && selectedTags.length > 0}}">
          <view 
            class="slider-item"
            wx:for="{{selectedTags}}" 
            wx:key="*this"
          >
            <text class="slider-label">{{item.name || item}}</text>
            <view class="slider-container">
              <text class="slider-count">{{item.count || 1}}é¢˜</text>
              <view class="number-control-wrapper">
                <!-- å‡å°‘æŒ‰é’® -->
                <view 
                  class="control-btn decrease-btn {{item.count <= 1 ? 'disabled' : ''}}"
                  bindtap="decreaseSliderValue"
                  data-index="{{index}}"
                >-</view>
                
                <!-- æ•°å­—æ˜¾ç¤ºå’Œåˆ»åº¦ -->
                <view class="number-display">
                  <text class="current-number">{{item.count || 1}}</text>
                  <view class="scale-dots">
                    <view 
                      class="dot {{dot <= (item.count || 1) ? 'active' : ''}}"
                      wx:for="{{getSliderTicks(index)}}"
                      wx:key="*this"
                      bindtap="setSliderValue"
                      data-index="{{index}}"
                      data-value="{{item}}"
                    ></view>
                  </view>
                </view>
                
                <!-- å¢åŠ æŒ‰é’® -->
                <view 
                  class="control-btn increase-btn {{item.count >= getSliderMax(index) ? 'disabled' : ''}}"
                  bindtap="increaseSliderValue"
                  data-index="{{index}}"
                >+</view>
              </view>
            </view>
            <text class="slider-remove" data-index="{{index}}" bindtap="removeSelectedTag">Ã—</text>
          </view>
        </view>
        
        <!-- ç©ºçŠ¶æ€æç¤º -->
        <view class="empty-state" wx:if="{{selectedTags.length === 0 && selectedTopics.length === 0}}">
          <text class="empty-text">
            {{homeworkType === 'topic' ? 'è¯·é€‰æ‹©è¯­æ³•ä¸“é¢˜' : 'è¯·é€‰æ‹©è¯­æ³•å°ç‚¹'}}
          </text>
        </view>
      </view>
      
      <!-- é«˜è€ƒé…æ¯”æ¨¡å¼æ˜¾ç¤ºå·²é€‰è¯­æ³•ç‚¹ -->
      <view class="gaokao-selected-points" wx:if="{{homeworkType === 'gaokao'}}">
        <view class="gaokao-header">
          <text class="gaokao-title">é«˜è€ƒé…æ¯”å·²ç”Ÿæˆ</text>
          <text class="gaokao-subtitle">å…±{{gaokaoRatio.selectedGrammarPoints.length}}ä¸ªè¯­æ³•ç‚¹ï¼Œæ¯é¢˜1é“</text>
          <button class="btn btn-small btn-outline" bindtap="regenerateGaokaoCombo">é‡æ–°ç”Ÿæˆ</button>
        </view>
        <view class="selected-points-grid">
          <view 
            class="selected-point-item"
            wx:for="{{gaokaoRatio.selectedGrammarPoints}}" 
            wx:key="*this"
          >
            <text class="point-name">{{item}}</text>
            <text class="point-count">1é¢˜</text>
            <text class="point-remove" data-point="{{item}}" bindtap="removeGaokaoPoint">Ã—</text>
          </view>
        </view>
      </view>
    </view>

    <!-- è°ƒè¯•ä¿¡æ¯ -->
    <view class="debug-info" wx:if="{{showDebugInfo}}">
      <text class="debug-text">è°ƒè¯•æ¨¡å¼ï¼šæ˜¾ç¤ºæ•°æ®ç»“æ„ä¿¡æ¯</text>
      <button class="btn btn-small" bindtap="toggleDebugInfo">éšè—è°ƒè¯•</button>
      <button class="btn btn-small" bindtap="forceDataRefresh">å¼ºåˆ¶åˆ·æ–°æ•°æ®</button>
      <button class="btn btn-small" bindtap="forceRenderPoints">å¼ºåˆ¶æ¸²æŸ“å°ç‚¹</button>
    </view>
    
    <!-- è¯­æ³•ç‚¹æ‰‹é£ç´åˆ—è¡¨ -->
    <view class="grammar-accordion">
      <view class="accordion-section" wx:for="{{grammarTopics}}" wx:key="id">
        <view 
          class="section-header {{item.expanded ? 'expanded' : ''}}"
          data-topic-id="{{item.id}}"
          data-id="{{item.id}}"
        >
          <view 
            class="section-title"
            bindtap="{{homeworkType === 'topic' ? 'selectGrammarTopic' : 'toggleTopic'}}"
            data-topic-id="{{item.id}}"
            data-id="{{item.id}}"
          >
            <text class="topic-name">{{item.name}}</text>
            <text class="topic-count" wx:if="{{categoryCounts[index] > 0}}" data-selected="true">å·²é€‰{{categoryCounts[index]}}é¢˜</text>
            <text class="topic-count" wx:else>{{item.questionCount}}é¢˜</text>
          </view>
          <view class="section-actions">
            <!-- ä¸“é¢˜æ¨¡å¼ï¼šæ˜¾ç¤ºé€‰æ‹©æ¡†ï¼Œéšè—å±•å¼€æŒ‰é’® -->
            <view class="checkbox {{item.selected ? 'checked' : ''}}" wx:if="{{homeworkType === 'topic'}}" data-id="{{item.id}}" bindtap="selectGrammarTopic"></view>
            
            <!-- è‡ªé€‰æ¨¡å¼ï¼šæ˜¾ç¤ºå±•å¼€æŒ‰é’®å’Œå…¨é€‰æŒ‰é’® -->
            <view wx:if="{{homeworkType !== 'topic'}}" class="custom-mode-actions">
              <view class="select-all-btn" bindtap="selectAllPoints" data-topic-id="{{item.id}}" catchtap="preventEventBubble" data-debug="true">å…¨é€‰</view>
              <view class="expand-icon" bindtap="toggleTopic" data-topic-id="{{item.id}}">{{item.expanded ? 'âˆ’' : '+'}}</view>
            </view>
          </view>
        </view>
        
        <!-- å°ç‚¹åˆ—è¡¨ -->
        <view class="section-content" wx:if="{{item.expanded}}">
          <block wx:for="{{item.points}}" wx:key="id" wx:for-item="point" wx:for-index="pointIndex">
            <view 
              class="point-item {{homeworkType === 'topic' ? 'disabled' : ''}} {{point.selected ? 'selected' : ''}}"
              data-point-id="{{point.id}}"
              bindtap="selectPoint"
            >
              <view class="point-info">
                <text class="point-name">{{point.name}}</text>
                <text class="point-count" wx:if="{{homeworkType === 'topic'}}">{{point.questionCount}}é¢˜</text>
                <!-- è°ƒè¯•ä¿¡æ¯ -->
                <text class="debug-info" wx:if="{{showDebugInfo}}" style="font-size: 20rpx; color: #999;">
                  ID:{{point.id}}|Name:{{point.name}}|Count:{{point.questionCount}}
                </text>
              </view>
              <view class="point-checkbox {{point.selected ? 'checked' : ''}}" wx:if="{{homeworkType !== 'topic'}}"></view>
            </view>
          </block>
        </view>
      </view>
    </view>
  </view>




  <!-- æ“ä½œæŒ‰é’® -->
  <view class="action-buttons" wx:if="{{homeworkType}}">
    <button 
      class="btn btn-primary" 
      bindtap="previewHomework"
    >é¢„è§ˆä½œä¸š</button>
    <button 
      class="btn btn-success" 
      bindtap="showPublishConfirm"
    >å‘å¸ƒä½œä¸š</button>
    <button 
      class="btn btn-outline" 
      bindtap="saveDraft"
    >æš‚å­˜</button>
    <button 
      class="btn btn-outline" 
      bindtap="toggleDebugInfo"
    >è°ƒè¯•æ•°æ®</button>
  </view>

  <!-- ä½œä¸šç±»å‹é€‰æ‹©å¼¹çª— -->
  <view class="modal" wx:if="{{showTypeSelector}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">é€‰æ‹©ä½œä¸šç±»å‹</text>
        <text class="close" bindtap="closeTypeSelector">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="type-grid">
          <view 
            class="type-item"
            wx:for="{{homeworkTypes}}" 
            wx:key="id"
            data-type="{{item.id}}"
            bindtap="selectHomeworkType"
          >
            <view class="type-icon" style="background: linear-gradient(135deg, {{item.color}} 0%, {{item.color}}CC 100%);">
              <text class="icon">{{item.icon}}</text>
            </view>
            <view class="type-content">
              <text class="title">{{item.title}}</text>
              <text class="subtitle">{{item.subtitle}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å‘å¸ƒç¡®è®¤å¼¹çª— -->
  <view class="modal" wx:if="{{showPublishConfirm}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">ç¡®è®¤å‘å¸ƒä½œä¸š</text>
        <text class="close" bindtap="closePublishConfirm">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="confirm-info">
          <text class="label">ä½œä¸šæ ‡é¢˜ï¼š</text>
          <text class="value">{{smartTitle}}</text>
        </view>
        <view class="confirm-info" wx:if="{{smartRemark}}">
          <text class="label">å¤‡æ³¨å†…å®¹ï¼š</text>
          <text class="value">{{smartRemark}}</text>
        </view>
        <view class="confirm-info">
          <text class="label">æˆªæ­¢æ—¶é—´ï¼š</text>
          <text class="value">2025-10-05 18:00</text>
        </view>
        <view class="confirm-info">
          <text class="label">å‘å¸ƒç­çº§ï¼š</text>
          <view class="class-selection">
            <view class="selected-classes" wx:if="{{selectedClasses.length > 0}}">
              <text class="class-tag" wx:for="{{selectedClasses}}" wx:key="id" wx:for-item="class">
                {{class.name}}
                <text class="remove-class" data-class-id="{{class.id}}" bindtap="removeSelectedClass">Ã—</text>
              </text>
            </view>
            <view class="no-class-selected" wx:else>
              <text class="placeholder">è¯·é€‰æ‹©ç­çº§</text>
            </view>
            <button class="btn btn-outline btn-small" bindtap="showClassSelection">é€‰æ‹©ç­çº§</button>
          </view>
        </view>
        <view class="confirm-tip">
          <text class="tip">è¯·ç¡®è®¤ä»¥ä¸Šä¿¡æ¯æ— è¯¯åå‘å¸ƒä½œä¸š</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="closePublishConfirm">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="publishHomework" loading="{{loading}}">ç¡®è®¤å‘å¸ƒ</button>
      </view>
    </view>
  </view>

  <!-- ç­çº§é€‰æ‹©å¼¹çª— -->
  <view class="modal" wx:if="{{showClassSelection}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">é€‰æ‹©å‘å¸ƒç­çº§</text>
        <text class="close" bindtap="closeClassSelection">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="class-list">
          <view 
            class="class-item {{selectedClassIds.indexOf(item.id) > -1 ? 'selected' : ''}}"
            wx:for="{{availableClasses}}" 
            wx:key="id"
            data-class-id="{{item.id}}"
            bindtap="toggleClassSelection"
          >
            <view class="class-info">
              <text class="class-name">{{item.name}}</text>
              <text class="class-stats">{{item.studentCount}}äºº</text>
            </view>
            <view class="select-indicator" wx:if="{{selectedClassIds.indexOf(item.id) > -1}}">âœ“</view>
          </view>
        </view>
        
        <view class="selection-summary" wx:if="{{selectedClasses.length > 0}}">
          <text class="summary-text">å·²é€‰æ‹© {{selectedClasses.length}} ä¸ªç­çº§</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="closeClassSelection">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="confirmClassSelection">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- å‘å¸ƒæˆåŠŸå¼¹çª— -->
  <view class="modal" wx:if="{{showPublishSuccess}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">å‘å¸ƒæˆåŠŸ</text>
        <text class="close" bindtap="closePublishSuccess">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="success-content">
          <text class="success-icon">âœ“</text>
          <text class="success-message">ä½œä¸šå‘å¸ƒæˆåŠŸï¼</text>
          <text class="success-detail">å­¦ç”Ÿç«¯å·²æ”¶åˆ°ä½œä¸šé€šçŸ¥</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-primary" bindtap="goToMaterials">ç”Ÿæˆå­¦æ¡ˆ</button>
        <button class="btn btn-secondary" bindtap="closePublishSuccess">å®Œæˆ</button>
      </view>
    </view>
  </view>

  <!-- æš‚å­˜ä½œä¸šæç¤ºå¼¹çª— -->
  <view class="modal" wx:if="{{showDraftPrompt}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">å‘ç°æœªå®Œæˆçš„ä½œä¸š</text>
        <text class="close" bindtap="startNewHomework">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="draft-info">
          <text class="draft-icon">ğŸ“</text>
          <text class="draft-message">æ‚¨æœ‰ä¸€ä¸ªæœªå‘å¸ƒçš„ä½œä¸šæš‚å­˜</text>
          <view class="draft-details">
            <text class="detail-item">ä½œä¸šç±»å‹ï¼š{{draftData.homeworkType === 'gaokao' ? 'é«˜è€ƒé…æ¯”10é¢˜' : draftData.homeworkType === 'topic' ? 'ä¸“é¢˜10é¢˜' : 'è‡ªé€‰10é¢˜'}}</text>
            <text class="detail-item">æš‚å­˜æ—¶é—´ï¼š{{draftData.formattedSavedAt || 'åˆšåˆš'}}</text>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="startNewHomework">é‡æ–°å¼€å§‹</button>
        <button class="btn btn-primary" bindtap="continueDraft">ç»§ç»­ç¼–è¾‘</button>
      </view>
    </view>
  </view>

  <!-- é¢„è§ˆå¼¹çª— -->
  <view class="preview-modal" wx:if="{{showPreview}}" bindtap="closePreview">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="title">ä½œä¸šé¢„è§ˆ</text>
        <text class="close" bindtap="closePreview">Ã—</text>
      </view>
      
      <view class="preview-content">
        <view class="preview-item">
          <text class="label">ä½œä¸šç±»å‹:</text>
          <text class="value">{{previewData.type}}</text>
        </view>
        <view class="preview-item">
          <text class="label">é¢˜ç›®æ€»æ•°:</text>
          <text class="value">{{previewData.totalQuestions}}é¢˜</text>
        </view>
        <view class="preview-item">
          <text class="label">å‡ºé¢˜é¡ºåº:</text>
          <text class="value">{{previewData.config.shuffleQuestions ? 'ä¹±åº' : 'é¡ºåº'}}</text>
        </view>
        
        <view class="selected-items">
          <text class="label">å·²é€‰å†…å®¹:</text>
          <view class="items-list">
            <text 
              class="item-tag"
              wx:for="{{previewData.selectedItems}}" 
              wx:key="id"
            >{{item.name || item.category}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
