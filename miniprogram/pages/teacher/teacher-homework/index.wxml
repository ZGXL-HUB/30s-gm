<!--æ•™å¸ˆç«¯å¸ƒç½®è¯­æ³•ä½œä¸šé¡µé¢-->
<view class="teacher-homework">
  <!-- ä½œä¸šç±»å‹é€‰æ‹©å¡ç‰‡å¼¹çª— -->
  <view class="homework-type-selector" wx:if="{{!homeworkType}}">
    <view class="selector-header">
      <text class="title">é€‰æ‹©ä½œä¸šç±»å‹</text>
      <text class="subtitle">è¯·é€‰æ‹©æ‚¨è¦å¸ƒç½®çš„ä½œä¸šç±»å‹</text>
    </view>
    <view class="type-cards">
      <view 
        class="type-card"
        wx:for="{{homeworkTypes}}" 
        wx:key="id"
        data-type="{{item.id}}"
        bindtap="selectHomeworkType"
      >
        <view class="card-icon" style="background: linear-gradient(135deg, {{item.color}} 0%, {{item.color}}CC 100%);">
          <text class="icon">{{item.icon}}</text>
        </view>
        <view class="card-content">
          <text class="title">{{item.title}}</text>
          <text class="subtitle">{{item.subtitle}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç»Ÿä¸€æ–‡ä»¶æ ‘ç•Œé¢ -->
  <view class="homework-content" wx:if="{{homeworkType}}">
    <!-- é¡¶éƒ¨å·²é€‰å†…å®¹æ ‡ç­¾ -->
    <view class="selected-content-header">
      <view class="header-row">
        <text class="header-title">å·²é€‰å†…å®¹</text>
        <!-- ä¹±åºå¼€å…³ -->
        <view class="shuffle-toggle">
          <text class="shuffle-label">ä¹±åºå‡ºé¢˜</text>
          <switch 
            checked="{{shuffleQuestions}}" 
            bindchange="toggleShuffle"
            color="#1890ff"
          />
        </view>
      </view>
      <view class="selected-tags" wx:if="{{homeworkType !== 'gaokao' && homeworkType !== 'topic'}}">
        <!-- æ€»é¢˜æ•°æ˜¾ç¤ºå’Œè¿›åº¦æ¡ -->
        <view class="total-questions-section" wx:if="{{selectedTags.length > 0 || selectedTopics.length > 0}}">
          <view class="total-info">
            <text class="total-label">æ€»é¢˜æ•°:</text>
            <text class="total-count">{{totalQuestions}}é¢˜</text>
            <text class="max-count">/ 20é¢˜</text>
          </view>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{(totalQuestions / 20) * 100}}%"></view>
          </view>
        </view>
        
        <!-- è‡ªé€‰æ¨¡å¼ï¼šè¯¦ç»†æ§åˆ¶ -->
        <view class="slider-section" wx:if="{{homeworkType === 'custom' && selectedTags.length > 0}}">
          <view 
            class="slider-item"
            wx:for="{{selectedTags}}" 
            wx:key="*this"
          >
            <text class="slider-label">{{item.name || item}}</text>
            <view class="slider-container">
              <text class="slider-count">{{item.count || 1}}é¢˜</text>
              <view class="number-control-wrapper">
                <!-- å‡å°‘æŒ‰é’® -->
                <view 
                  class="control-btn decrease-btn {{item.count <= 1 ? 'disabled' : ''}}"
                  bindtap="decreaseSliderValue"
                  data-index="{{index}}"
                >-</view>
                
                <!-- æ•°å­—æ˜¾ç¤ºå’Œåˆ»åº¦ -->
                <view class="number-display">
                  <text class="current-number">{{item.count || 1}}</text>
                  <view class="scale-dots">
                    <view 
                      class="dot {{dot <= (item.count || 1) ? 'active' : ''}}"
                      wx:for="{{getSliderTicks(index)}}"
                      wx:key="*this"
                      bindtap="setSliderValue"
                      data-index="{{index}}"
                      data-value="{{item}}"
                    ></view>
                  </view>
                </view>
                
                <!-- å¢åŠ æŒ‰é’® -->
                <view 
                  class="control-btn increase-btn {{item.count >= getSliderMax(index) || totalQuestions >= 20 ? 'disabled' : ''}}"
                  bindtap="increaseSliderValue"
                  data-index="{{index}}"
                >+</view>
              </view>
            </view>
            <text class="slider-remove" data-index="{{index}}" bindtap="removeSelectedTag">Ã—</text>
          </view>
        </view>
        
        <!-- ç©ºçŠ¶æ€æç¤º -->
        <view class="empty-state" wx:if="{{selectedTags.length === 0 && selectedTopics.length === 0}}">
          <text class="empty-text">
            {{homeworkType === 'topic' ? 'è¯·é€‰æ‹©è¯­æ³•ä¸“é¢˜' : 'è¯·é€‰æ‹©è¯­æ³•å°ç‚¹'}}
          </text>
        </view>
      </view>
      
      <!-- é«˜è€ƒé…æ¯”æ¨¡å¼æ˜¾ç¤ºå·²é€‰è¯­æ³•ç‚¹ -->
      <view class="gaokao-selected-points" wx:if="{{homeworkType === 'gaokao'}}">
        <view class="gaokao-header">
          <text class="gaokao-title">é«˜è€ƒé…æ¯”å·²ç”Ÿæˆ</text>
          <text class="gaokao-subtitle">å…±{{gaokaoRatio.selectedGrammarPoints.length}}ä¸ªè¯­æ³•ç‚¹{{variantCount > 0 ? 'ï¼Œæ€»é¢˜æ•°ï¼š' + totalQuestions + 'é¢˜ï¼ˆ' + gaokaoRatio.selectedGrammarPoints.length + 'é“åŸé¢˜ + ' + (gaokaoRatio.selectedGrammarPoints.length * variantCount) + 'é“å˜å¼é¢˜ï¼‰' : 'ï¼Œæ¯é¢˜1é“'}}</text>
        </view>
        <view class="selected-points-grid">
          <view 
            class="selected-point-item"
            wx:for="{{gaokaoRatio.selectedGrammarPoints}}" 
            wx:key="*this"
          >
            <text class="point-name">{{item}}</text>
            <text class="point-remove" data-point="{{item}}" bindtap="removeGaokaoPoint">Ã—</text>
          </view>
        </view>
      </view>
    </view>

    
    <!-- è¯­æ³•ç‚¹æ‰‹é£ç´åˆ—è¡¨ -->
    <view class="grammar-accordion">
      <view class="accordion-section" wx:for="{{grammarTopics}}" wx:key="id">
        <view 
          class="section-header {{item.expanded ? 'expanded' : ''}}"
          data-topic-id="{{item.id}}"
          data-id="{{item.id}}"
          bindtap="{{homeworkType === 'topic' ? 'selectGrammarTopic' : 'toggleTopic'}}"
        >
          <view class="section-title">
            <text class="topic-name">{{item.name}}</text>
            <text class="topic-count" wx:if="{{categoryCounts[index] > 0}}" data-selected="true">{{categoryCounts[index]}}ä¸ªè¯­æ³•ç‚¹</text>
            <text class="topic-count" wx:else>{{item.questionCount}}ä¸ªè¯­æ³•ç‚¹</text>
          </view>
          <view class="section-actions">
            <!-- ä¸“é¢˜æ¨¡å¼ï¼šæ˜¾ç¤ºé€‰æ‹©æ¡†ï¼Œéšè—å±•å¼€æŒ‰é’® -->
            <view class="checkbox {{item.selected ? 'checked' : ''}}" wx:if="{{homeworkType === 'topic'}}" data-id="{{item.id}}" catchtap="selectGrammarTopic"></view>
            
            <!-- è‡ªé€‰æ¨¡å¼ï¼šæ˜¾ç¤ºå±•å¼€æŒ‰é’®å’Œå…¨é€‰æŒ‰é’® -->
            <view wx:if="{{homeworkType !== 'topic'}}" class="custom-mode-actions">
              <view class="select-all-btn" catchtap="selectAllPoints" data-topic-id="{{item.id}}">å…¨é€‰</view>
              <view class="expand-icon" catchtap="toggleTopic" data-topic-id="{{item.id}}">{{item.expanded ? 'â–¼' : 'â–¶'}}</view>
            </view>
          </view>
        </view>
        
        <!-- å°ç‚¹åˆ—è¡¨ -->
        <view class="section-content" wx:if="{{item.expanded}}">
          <block wx:for="{{item.points}}" wx:key="id" wx:for-item="point" wx:for-index="pointIndex">
            <view 
              class="point-item {{homeworkType === 'topic' ? 'disabled' : ''}} {{point.selected ? 'selected' : ''}}"
              data-point-id="{{point.id}}"
              bindtap="selectPoint"
            >
              <view class="point-info">
                <text class="point-name">{{point.name}}</text>
                <text class="point-count" wx:if="{{homeworkType === 'topic'}}">{{point.questionCount}}ä¸ªè¯­æ³•ç‚¹</text>
              </view>
              <view class="point-checkbox {{point.selected ? 'checked' : ''}}" wx:if="{{homeworkType !== 'topic'}}"></view>
            </view>
          </block>
        </view>
      </view>
    </view>
  </view>




  <!-- æ‚¬æµ®é¢„è§ˆæŒ‰é’®ï¼ˆé«˜è€ƒé…æ¯”æ¨¡å¼ï¼‰ -->
  <view 
    class="floating-preview-btn show" 
    wx:if="{{homeworkType === 'gaokao' && gaokaoRatio.selectedGrammarPoints.length > 0}}"
    bindtap="showVariantSelector"
  >
    <view class="floating-btn-content">
      <text class="floating-btn-icon">ğŸ‘</text>
      <text class="floating-btn-text">æˆ‘é€‰å¥½äº†</text>
    </view>
  </view>

  <!-- æ‚¬æµ®é¢„è§ˆæŒ‰é’®ï¼ˆè‡ªé€‰æ¨¡å¼ï¼‰ -->
  <view 
    class="floating-preview-btn show" 
    wx:if="{{homeworkType === 'custom' && selectedTags.length > 0}}"
    bindtap="showVariantSelector"
  >
    <view class="floating-btn-content">
      <text class="floating-btn-icon">ğŸ‘</text>
      <text class="floating-btn-text">æˆ‘é€‰å¥½äº†</text>
    </view>
  </view>

  <!-- æ‚¬æµ®é‡é€‰æŒ‰é’®ï¼ˆé«˜è€ƒé…æ¯”æ¨¡å¼ï¼‰ -->
  <view 
    class="floating-regenerate-btn show" 
    wx:if="{{homeworkType === 'gaokao' && gaokaoRatio.selectedGrammarPoints.length > 0}}"
    bindtap="regenerateGaokaoCombo"
  >
    <view class="floating-btn-content">
      <text class="floating-btn-icon">â†»</text>
      <text class="floating-btn-text">é‡é€‰ä¸€æ‰¹</text>
    </view>
  </view>
  
  <!-- æ‚¬æµ®æ¸…ç©ºæŒ‰é’®ï¼ˆè‡ªé€‰æ¨¡å¼ï¼‰ -->
  <view 
    class="floating-clear-btn show" 
    wx:if="{{homeworkType === 'custom' && selectedTags.length > 0}}"
    bindtap="clearAllSelections"
  >
    <view class="floating-btn-content">
      <text class="floating-btn-icon">ğŸ—‘ï¸</text>
      <text class="floating-btn-text">æ¸…ç©º</text>
    </view>
  </view>

  <!-- ä½œä¸šç±»å‹é€‰æ‹©å¼¹çª— -->
  <view class="modal" wx:if="{{showTypeSelector}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">é€‰æ‹©ä½œä¸šç±»å‹</text>
        <text class="close" bindtap="closeTypeSelector">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="type-grid">
          <view 
            class="type-item"
            wx:for="{{homeworkTypes}}" 
            wx:key="id"
            data-type="{{item.id}}"
            bindtap="selectHomeworkType"
          >
            <view class="type-icon" style="background: linear-gradient(135deg, {{item.color}} 0%, {{item.color}}CC 100%);">
              <text class="icon">{{item.icon}}</text>
            </view>
            <view class="type-content">
              <text class="title">{{item.title}}</text>
              <text class="subtitle">{{item.subtitle}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å‘å¸ƒç¡®è®¤å¼¹çª— -->
  <view class="modal" wx:if="{{showPublishConfirm}}">
    <view class="modal-content">
        <view class="modal-header">
          <text class="title">ç¡®è®¤å­¦æ¡ˆå†…å®¹</text>
          <text class="close" bindtap="closePublishConfirm">Ã—</text>
        </view>
      
      <view class="modal-body">
        <view class="confirm-info">
          <text class="label">å­¦æ¡ˆæ ‡é¢˜ï¼š</text>
          <text class="value">{{smartTitle}}</text>
        </view>
        <view class="confirm-tip">
          <text class="tip">è¯·ç¡®è®¤ä»¥ä¸Šä¿¡æ¯æ— è¯¯åç”Ÿæˆå­¦æ¡ˆ</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="closePublishConfirm">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="publishHomework" loading="{{loading}}">ç¡®è®¤ç”Ÿæˆ</button>
      </view>
    </view>
  </view>

  <!-- ç­çº§é€‰æ‹©å¼¹çª— -->
  <view class="modal" wx:if="{{showClassSelection}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">é€‰æ‹©å‘å¸ƒç­çº§</text>
        <text class="close" bindtap="closeClassSelection">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="class-notice">
          <text class="notice-text">âš ï¸ æ³¨æ„ï¼šå­¦ç”Ÿå…³è”åŠŸèƒ½æš‚æœªå¼€æ”¾ï¼Œä»¥ä¸‹ä¸ºæ¨¡æ‹Ÿç­çº§æ•°æ®</text>
        </view>
        
        <view class="class-list">
          <view 
            class="class-item {{selectedClassIds.indexOf(item.id) > -1 ? 'selected' : ''}}"
            wx:for="{{availableClasses}}" 
            wx:key="id"
            data-class-id="{{item.id}}"
            bindtap="toggleClassSelection"
          >
            <view class="class-info">
              <text class="class-name">{{item.name}} (æ¨¡æ‹Ÿ)</text>
              <text class="class-stats">{{item.studentCount}}äºº (æ¨¡æ‹Ÿæ•°æ®)</text>
            </view>
            <view class="select-indicator" wx:if="{{selectedClassIds.indexOf(item.id) > -1}}">âœ“</view>
          </view>
        </view>
        
        <view class="selection-summary" wx:if="{{selectedClasses.length > 0}}">
          <text class="summary-text">å·²é€‰æ‹© {{selectedClasses.length}} ä¸ªæ¨¡æ‹Ÿç­çº§</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="closeClassSelection">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="confirmClassSelection">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- å‘å¸ƒæˆåŠŸå¼¹çª— -->
  <view class="modal" wx:if="{{showPublishSuccess}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">å‘å¸ƒæˆåŠŸ</text>
        <text class="close" bindtap="closePublishSuccess">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="success-content">
          <text class="success-icon">âœ“</text>
          <text class="success-message">ä½œä¸šå‘å¸ƒæˆåŠŸï¼</text>
          <text class="success-detail">å­¦ç”Ÿç«¯å·²æ”¶åˆ°ä½œä¸šé€šçŸ¥</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-primary" bindtap="goToMaterials">ç”Ÿæˆå­¦æ¡ˆ</button>
        <button class="btn btn-secondary" bindtap="closePublishSuccess">å®Œæˆ</button>
      </view>
    </view>
  </view>


  <!-- é¢„è§ˆå¼¹çª— -->
  <view class="preview-modal" wx:if="{{showPreview}}" bindtap="closePreview">
    <view class="modal-content" catchtap="preventClose">
        <view class="modal-header">
          <text class="title">å·²é€‰è¯­æ³•ç‚¹æ±‡æ€»</text>
          <text class="close" bindtap="closePreview">Ã—</text>
        </view>
      
      <view class="preview-content">
        <view class="preview-item">
          <text class="label">å­¦æ¡ˆç±»å‹:</text>
          <text class="value">{{previewData.type}}</text>
        </view>
        <view class="preview-item">
          <text class="label">è¯­æ³•ç‚¹æ•°é‡:</text>
          <text class="value">{{previewData.totalQuestions}}ä¸ªè¯­æ³•ç‚¹</text>
        </view>
        <view class="preview-item">
          <text class="label">å‡ºé¢˜é¡ºåº:</text>
          <text class="value">{{previewData.config.shuffleQuestions ? 'ä¹±åº' : 'é¡ºåº'}}</text>
        </view>
        
        <view class="selected-items">
          <text class="label">å·²é€‰å†…å®¹:</text>
          <view class="items-list">
            <text 
              class="item-tag"
              wx:for="{{previewData.selectedItems}}" 
              wx:key="id"
            >{{item.name || item.category}}</text>
          </view>
        </view>
      </view>
      
      <!-- å¼¹çª—ä¸­çš„æ“ä½œæŒ‰é’® -->
      <view class="modal-actions">
        <button class="btn btn-secondary" bindtap="addVariants">+å¢åŠ å˜å¼é¢˜</button>
        <button class="btn btn-primary" bindtap="goToPreview">æ— å˜å¼ï¼Œè¿›å…¥é¢„è§ˆ</button>
      </view>
      
      <!-- å˜å¼é¢˜çŠ¶æ€æ˜¾ç¤º -->
      <view class="variant-status">
        <text class="status-text">å˜å¼é¢˜ï¼š{{variantCount > 0 ? variantCount + 'é“' : 'æœªé€‰æ‹©'}}</text>
      </view>
    </view>
  </view>
</view>
