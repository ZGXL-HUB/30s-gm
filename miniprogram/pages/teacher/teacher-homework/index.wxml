<!--教师端布置语法作业页面-->
<view class="teacher-homework">
  <!-- 作业类型选择卡片弹窗 -->
  <view class="homework-type-selector" wx:if="{{!homeworkType}}">
    <view class="selector-header">
      <text class="title">选择作业类型</text>
      <text class="subtitle">请选择您要布置的作业类型</text>
    </view>
    <view class="type-cards">
      <view 
        class="type-card"
        wx:for="{{homeworkTypes}}" 
        wx:key="id"
        data-type="{{item.id}}"
        bindtap="selectHomeworkType"
      >
        <view class="card-icon" style="background: linear-gradient(135deg, {{item.color}} 0%, {{item.color}}CC 100%);">
          <text class="icon">{{item.icon}}</text>
        </view>
        <view class="card-content">
          <text class="title">{{item.title}}</text>
          <text class="subtitle">{{item.subtitle}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 统一文件树界面 -->
  <view class="homework-content" wx:if="{{homeworkType}}">
    <!-- 顶部已选内容标签 -->
    <view class="selected-content-header">
      <view class="header-row">
        <text class="header-title">已选内容</text>
        <!-- 乱序开关 -->
        <view class="shuffle-toggle">
          <text class="shuffle-label">乱序出题</text>
          <switch 
            checked="{{shuffleQuestions}}" 
            bindchange="toggleShuffle"
            color="#1890ff"
          />
        </view>
      </view>
      <view class="selected-tags" wx:if="{{homeworkType !== 'gaokao' && homeworkType !== 'topic'}}">
        <!-- 总题数显示和进度条 -->
        <view class="total-questions-section" wx:if="{{selectedTags.length > 0 || selectedTopics.length > 0}}">
          <view class="total-info">
            <text class="total-label">总题数:</text>
            <text class="total-count">{{totalQuestions}}题</text>
            <text class="max-count">/ 20题</text>
          </view>
          <view class="progress-bar">
            <view class="progress-fill" style="width: {{(totalQuestions / 20) * 100}}%"></view>
          </view>
        </view>
        
        <!-- 自选模式：详细控制 -->
        <view class="slider-section" wx:if="{{homeworkType === 'custom' && selectedTags.length > 0}}">
          <view 
            class="slider-item"
            wx:for="{{selectedTags}}" 
            wx:key="*this"
          >
            <text class="slider-label">{{item.name || item}}</text>
            <view class="slider-container">
              <text class="slider-count">{{item.count || 1}}题</text>
              <view class="number-control-wrapper">
                <!-- 减少按钮 -->
                <view 
                  class="control-btn decrease-btn {{item.count <= 1 ? 'disabled' : ''}}"
                  bindtap="decreaseSliderValue"
                  data-index="{{index}}"
                >-</view>
                
                <!-- 数字显示和刻度 -->
                <view class="number-display">
                  <text class="current-number">{{item.count || 1}}</text>
                  <view class="scale-dots">
                    <view 
                      class="dot {{dot <= (item.count || 1) ? 'active' : ''}}"
                      wx:for="{{getSliderTicks(index)}}"
                      wx:key="*this"
                      bindtap="setSliderValue"
                      data-index="{{index}}"
                      data-value="{{item}}"
                    ></view>
                  </view>
                </view>
                
                <!-- 增加按钮 -->
                <view 
                  class="control-btn increase-btn {{item.count >= getSliderMax(index) || totalQuestions >= 20 ? 'disabled' : ''}}"
                  bindtap="increaseSliderValue"
                  data-index="{{index}}"
                >+</view>
              </view>
            </view>
            <text class="slider-remove" data-index="{{index}}" bindtap="removeSelectedTag">×</text>
          </view>
        </view>
        
        <!-- 空状态提示 -->
        <view class="empty-state" wx:if="{{selectedTags.length === 0 && selectedTopics.length === 0}}">
          <text class="empty-text">
            {{homeworkType === 'topic' ? '请选择语法专题' : '请选择语法小点'}}
          </text>
        </view>
      </view>
      
      <!-- 高考配比模式显示已选语法点 -->
      <view class="gaokao-selected-points" wx:if="{{homeworkType === 'gaokao'}}">
        <view class="gaokao-header">
          <text class="gaokao-title">高考配比已生成</text>
          <text class="gaokao-subtitle">共{{gaokaoRatio.selectedGrammarPoints.length}}个语法点，每题1道</text>
          <button class="btn btn-small btn-white regenerate-btn" bindtap="regenerateGaokaoCombo">↻ 重选一批</button>
        </view>
        <view class="selected-points-grid">
          <view 
            class="selected-point-item"
            wx:for="{{gaokaoRatio.selectedGrammarPoints}}" 
            wx:key="*this"
          >
            <text class="point-name">{{item}}</text>
            <text class="point-remove" data-point="{{item}}" bindtap="removeGaokaoPoint">×</text>
          </view>
        </view>
      </view>
    </view>

    
    <!-- 语法点手风琴列表 -->
    <view class="grammar-accordion">
      <view class="accordion-section" wx:for="{{grammarTopics}}" wx:key="id">
        <view 
          class="section-header {{item.expanded ? 'expanded' : ''}}"
          data-topic-id="{{item.id}}"
          data-id="{{item.id}}"
          bindtap="{{homeworkType === 'topic' ? 'selectGrammarTopic' : 'toggleTopic'}}"
        >
          <view class="section-title">
            <text class="topic-name">{{item.name}}</text>
            <text class="topic-count" wx:if="{{categoryCounts[index] > 0}}" data-selected="true">{{categoryCounts[index]}}个语法点</text>
            <text class="topic-count" wx:else>{{item.questionCount}}个语法点</text>
          </view>
          <view class="section-actions">
            <!-- 专题模式：显示选择框，隐藏展开按钮 -->
            <view class="checkbox {{item.selected ? 'checked' : ''}}" wx:if="{{homeworkType === 'topic'}}" data-id="{{item.id}}" catchtap="selectGrammarTopic"></view>
            
            <!-- 自选模式：显示展开按钮和全选按钮 -->
            <view wx:if="{{homeworkType !== 'topic'}}" class="custom-mode-actions">
              <view class="select-all-btn" catchtap="selectAllPoints" data-topic-id="{{item.id}}">全选</view>
              <view class="expand-icon" catchtap="toggleTopic" data-topic-id="{{item.id}}">{{item.expanded ? '▼' : '▶'}}</view>
            </view>
          </view>
        </view>
        
        <!-- 小点列表 -->
        <view class="section-content" wx:if="{{item.expanded}}">
          <block wx:for="{{item.points}}" wx:key="id" wx:for-item="point" wx:for-index="pointIndex">
            <view 
              class="point-item {{homeworkType === 'topic' ? 'disabled' : ''}} {{point.selected ? 'selected' : ''}}"
              data-point-id="{{point.id}}"
              bindtap="selectPoint"
            >
              <view class="point-info">
                <text class="point-name">{{point.name}}</text>
                <text class="point-count" wx:if="{{homeworkType === 'topic'}}">{{point.questionCount}}个语法点</text>
              </view>
              <view class="point-checkbox {{point.selected ? 'checked' : ''}}" wx:if="{{homeworkType !== 'topic'}}"></view>
            </view>
          </block>
        </view>
      </view>
    </view>
  </view>




  <!-- 操作按钮 -->
  <!-- 专题模式：选择专题后直接跳转，不需要"我选好了"按钮 -->
  <view class="action-buttons" wx:if="{{homeworkType && homeworkType !== 'topic'}}">
        <button 
          class="btn btn-primary btn-full" 
          bindtap="showVariantSelector"
        >我选好了</button>
  </view>

  <!-- 作业类型选择弹窗 -->
  <view class="modal" wx:if="{{showTypeSelector}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">选择作业类型</text>
        <text class="close" bindtap="closeTypeSelector">×</text>
      </view>
      
      <view class="modal-body">
        <view class="type-grid">
          <view 
            class="type-item"
            wx:for="{{homeworkTypes}}" 
            wx:key="id"
            data-type="{{item.id}}"
            bindtap="selectHomeworkType"
          >
            <view class="type-icon" style="background: linear-gradient(135deg, {{item.color}} 0%, {{item.color}}CC 100%);">
              <text class="icon">{{item.icon}}</text>
            </view>
            <view class="type-content">
              <text class="title">{{item.title}}</text>
              <text class="subtitle">{{item.subtitle}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 发布确认弹窗 -->
  <view class="modal" wx:if="{{showPublishConfirm}}">
    <view class="modal-content">
        <view class="modal-header">
          <text class="title">确认学案内容</text>
          <text class="close" bindtap="closePublishConfirm">×</text>
        </view>
      
      <view class="modal-body">
        <view class="confirm-info">
          <text class="label">学案标题：</text>
          <text class="value">{{smartTitle}}</text>
        </view>
        <view class="confirm-tip">
          <text class="tip">请确认以上信息无误后生成学案</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="closePublishConfirm">取消</button>
        <button class="btn btn-primary" bindtap="publishHomework" loading="{{loading}}">确认生成</button>
      </view>
    </view>
  </view>

  <!-- 班级选择弹窗 -->
  <view class="modal" wx:if="{{showClassSelection}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">选择发布班级</text>
        <text class="close" bindtap="closeClassSelection">×</text>
      </view>
      
      <view class="modal-body">
        <view class="class-notice">
          <text class="notice-text">⚠️ 注意：学生关联功能暂未开放，以下为模拟班级数据</text>
        </view>
        
        <view class="class-list">
          <view 
            class="class-item {{selectedClassIds.indexOf(item.id) > -1 ? 'selected' : ''}}"
            wx:for="{{availableClasses}}" 
            wx:key="id"
            data-class-id="{{item.id}}"
            bindtap="toggleClassSelection"
          >
            <view class="class-info">
              <text class="class-name">{{item.name}} (模拟)</text>
              <text class="class-stats">{{item.studentCount}}人 (模拟数据)</text>
            </view>
            <view class="select-indicator" wx:if="{{selectedClassIds.indexOf(item.id) > -1}}">✓</view>
          </view>
        </view>
        
        <view class="selection-summary" wx:if="{{selectedClasses.length > 0}}">
          <text class="summary-text">已选择 {{selectedClasses.length}} 个模拟班级</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-secondary" bindtap="closeClassSelection">取消</button>
        <button class="btn btn-primary" bindtap="confirmClassSelection">确定</button>
      </view>
    </view>
  </view>

  <!-- 发布成功弹窗 -->
  <view class="modal" wx:if="{{showPublishSuccess}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="title">发布成功</text>
        <text class="close" bindtap="closePublishSuccess">×</text>
      </view>
      
      <view class="modal-body">
        <view class="success-content">
          <text class="success-icon">✓</text>
          <text class="success-message">作业发布成功！</text>
          <text class="success-detail">学生端已收到作业通知</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-primary" bindtap="goToMaterials">生成学案</button>
        <button class="btn btn-secondary" bindtap="closePublishSuccess">完成</button>
      </view>
    </view>
  </view>


  <!-- 预览弹窗 -->
  <view class="preview-modal" wx:if="{{showPreview}}" bindtap="closePreview">
    <view class="modal-content" catchtap="preventClose">
        <view class="modal-header">
          <text class="title">已选语法点汇总</text>
          <text class="close" bindtap="closePreview">×</text>
        </view>
      
      <view class="preview-content">
        <view class="preview-item">
          <text class="label">学案类型:</text>
          <text class="value">{{previewData.type}}</text>
        </view>
        <view class="preview-item">
          <text class="label">语法点数量:</text>
          <text class="value">{{previewData.totalQuestions}}个语法点</text>
        </view>
        <view class="preview-item">
          <text class="label">出题顺序:</text>
          <text class="value">{{previewData.config.shuffleQuestions ? '乱序' : '顺序'}}</text>
        </view>
        
        <view class="selected-items">
          <text class="label">已选内容:</text>
          <view class="items-list">
            <text 
              class="item-tag"
              wx:for="{{previewData.selectedItems}}" 
              wx:key="id"
            >{{item.name || item.category}}</text>
          </view>
        </view>
      </view>
      
      <!-- 弹窗中的操作按钮 -->
      <view class="modal-actions">
        <button class="btn btn-secondary" bindtap="addVariants">+增加变式题</button>
        <button class="btn btn-primary" bindtap="goToPreview">无变式，进入预览</button>
      </view>
      
      <!-- 变式题状态显示 -->
      <view class="variant-status">
        <text class="status-text">变式题：{{variantCount > 0 ? variantCount + '道' : '未选择'}}</text>
      </view>
    </view>
  </view>
</view>
