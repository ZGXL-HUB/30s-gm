<!--æ•™å¸ˆç«¯æˆ‘çš„å­¦æ¡ˆé¡µé¢-->
<view class="teacher-materials">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header">
    <text class="page-title">æˆ‘çš„å­¦æ¡ˆ</text>
    <text class="page-subtitle">é…å¥—ææ–™ç®¡ç†</text>
  </view>

  <!-- é…å¥—ææ–™ -->
  <view class="tab-content">
    <view class="section-header">
      <view class="header-left">
        <text class="title">æœ€è¿‘ç”Ÿæˆçš„é…å¥—ææ–™</text>
        <text class="subtitle">åŸºäºä½œä¸šç»“æœè‡ªåŠ¨ç”Ÿæˆ</text>
      </view>
      <view class="header-right">
        <button 
          class="refresh-btn {{isRefreshing ? 'refreshing' : ''}}"
          bindtap="refreshMaterials"
          disabled="{{isRefreshing}}"
        >
          <text class="refresh-icon">{{isRefreshing ? 'âŸ³' : 'â†»'}}</text>
          <text class="refresh-text">{{isRefreshing ? 'åˆ·æ–°ä¸­...' : 'åˆ·æ–°'}}</text>
        </button>
      </view>
    </view>
    
    <!-- åŠ è½½çŠ¶æ€ -->
    <view class="loading-container" wx:if="{{isRefreshing && recentMaterials.length === 0}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">æ­£åœ¨åŠ è½½é…å¥—ææ–™...</text>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{!isRefreshing && recentMaterials.length === 0}}">
      <text class="empty-icon">ğŸ“„</text>
      <text class="empty-title">æš‚æ— é…å¥—ææ–™</text>
      <text class="empty-desc">å‘å¸ƒä½œä¸šåå°†è‡ªåŠ¨ç”Ÿæˆé…å¥—ææ–™</text>
      
      <!-- è°ƒè¯•ä¿¡æ¯ -->
      <view class="debug-info" wx:if="{{fromHomework}}">
        <text class="debug-title">è°ƒè¯•ä¿¡æ¯ï¼š</text>
        <text class="debug-item">ä½œä¸šID: {{homeworkId}}</text>
        <text class="debug-item">ä½œä¸šæ ‡é¢˜: {{homeworkTitle}}</text>
        <text class="debug-item">æ¥æº: ä½œä¸šå‘å¸ƒé¡µé¢</text>
      </view>
      
      <button class="btn btn-primary" bindtap="goToHomework">å»å¸ƒç½®ä½œä¸š</button>
      <button class="btn btn-outline" bindtap="refreshMaterials" style="margin-top: 20rpx;">æ‰‹åŠ¨åˆ·æ–°</button>
    </view>
    
    <view class="materials-list" wx:if="{{recentMaterials.length > 0}}">
      <view 
        class="material-item {{item.status === 'generating' ? 'generating' : ''}}"
        wx:for="{{recentMaterials}}" 
        wx:key="id"
      >
        <view class="material-info">
          <view class="material-header">
            <text class="title">{{item.title}}</text>
            <view class="type-badge type-{{item.type}}">{{item.type.toUpperCase()}}</view>
          </view>
          <text class="time">{{formatTime(item.createdAt)}}</text>
          <view class="stats">
            <text class="stat">ç”Ÿæˆæ—¶é—´: {{formatTime(item.createdAt)}}</text>
          </view>
        </view>
        <!-- ç”Ÿæˆä¸­çŠ¶æ€ -->
        <view class="generating-status" wx:if="{{item.status === 'generating'}}">
          <view class="generating-content">
            <view class="generating-spinner"></view>
            <text class="generating-text">æ­£åœ¨ç”Ÿæˆææ–™...</text>
          </view>
        </view>
        
        <view class="material-actions" wx:else>
          <!-- ä¸»è¦æ“ä½œï¼šç»Ÿä¸€ç”Ÿæˆæµç¨‹ -->
          <button 
            class="btn btn-primary-new"
            data-id="{{item.id}}"
            bindtap="goToUnifiedGenerate"
            disabled="{{item.status === 'generating'}}"
          >{{item.status === 'generating' ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆå­¦æ¡ˆ'}}</button>
          
          <!-- æ¬¡è¦æ“ä½œï¼šæŸ¥çœ‹è¯¦æƒ… -->
          <button 
            class="btn btn-outline"
            data-id="{{item.id}}"
            bindtap="viewAssignmentDetail"
          >è¯¦æƒ…</button>
        </view>
      </view>
    </view>
  </view>



  <!-- ä½œä¸šè¯¦æƒ…å¼¹çª— -->
  <view class="modal" wx:if="{{showAssignmentDetail}}" bindtap="closeAssignmentDetail">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="title">ä½œä¸šè¯¦æƒ…</text>
        <text class="close" bindtap="closeAssignmentDetail">Ã—</text>
      </view>
      
      <view class="modal-body" wx:if="{{selectedAssignment}}">
        <view class="assignment-detail">
          <view class="detail-item">
            <text class="label">ä½œä¸šæ ‡é¢˜ï¼š</text>
            <text class="value">{{selectedAssignment.title}}</text>
          </view>
          <view class="detail-item" wx:if="{{selectedAssignment.remark}}">
            <text class="label">å¤‡æ³¨å†…å®¹ï¼š</text>
            <text class="value">{{selectedAssignment.remark}}</text>
          </view>
          <view class="detail-item">
            <text class="label">æˆªæ­¢æ—¶é—´ï¼š</text>
            <text class="value">{{selectedAssignment.deadline}}</text>
          </view>
          <view class="detail-item">
            <text class="label">å®Œæˆè¿›åº¦ï¼š</text>
            <text class="value">å·²å®Œæˆ {{selectedAssignment.completedCount || 12}}/{{selectedAssignment.totalCount || 33}} äºº</text>
          </view>
          <view class="detail-item">
            <text class="label">å¹³å‡æ­£ç¡®ç‡ï¼š</text>
            <text class="value">{{selectedAssignment.averageAccuracy || 78}}%</text>
          </view>
          <view class="detail-item">
            <text class="label">åˆ›å»ºæ—¶é—´ï¼š</text>
            <text class="value">{{selectedAssignment.createdAt}}</text>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-primary" bindtap="closeAssignmentDetail">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- é¢˜ç›®åˆ—è¡¨å¼¹çª— -->
  <view class="modal" wx:if="{{showQuestionList}}" bindtap="closeQuestionList">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="title">é¢˜ç›®åˆ—è¡¨</text>
        <text class="close" bindtap="closeQuestionList">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="question-list">
          <view 
            class="question-item {{item.id === rollcallData.currentQuestion ? 'active' : ''}}"
            wx:for="{{questionList}}" 
            wx:key="id"
            data-question-id="{{item.id}}"
            bindtap="jumpToQuestion"
          >
            <text class="question-number">ç¬¬{{item.id}}é¢˜</text>
            <text class="question-title">{{item.title}}</text>
            <view class="question-status">
              <text class="status-text" wx:if="{{item.status === 'completed'}}">å·²å®Œæˆ</text>
              <text class="status-text" wx:elif="{{item.status === 'current'}}">å½“å‰</text>
              <text class="status-text" wx:else>æœªå¼€å§‹</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-primary" bindtap="closeQuestionList">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- äº‘ç«¯å¤‡ä»½ç®¡ç†å¼¹çª— -->
  <view class="modal" wx:if="{{showBackupModal}}" bindtap="closeBackupModal">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="title">äº‘ç«¯å¤‡ä»½ç®¡ç†</text>
        <text class="close" bindtap="closeBackupModal">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="backup-status">
          <view class="status-item">
            <text class="status-label">è¿æ¥çŠ¶æ€ï¼š</text>
            <text class="status-value status-{{cloudBackupStatus}}">
              {{cloudBackupStatus === 'connected' ? 'å·²è¿æ¥' : cloudBackupStatus === 'connecting' ? 'è¿æ¥ä¸­' : cloudBackupStatus === 'error' ? 'è¿æ¥å¤±è´¥' : 'æœªè¿æ¥'}}
            </text>
          </view>
          <view class="status-item" wx:if="{{lastBackupTime}}">
            <text class="status-label">ä¸Šæ¬¡å¤‡ä»½ï¼š</text>
            <text class="status-value">{{formatTime(lastBackupTime)}}</text>
          </view>
        </view>
        
        <view class="backup-actions">
          <button class="btn btn-primary" bindtap="manualBackup">ç«‹å³å¤‡ä»½</button>
          <button class="btn btn-outline" bindtap="restoreFromCloud">ä»äº‘ç«¯æ¢å¤</button>
          <button class="btn btn-outline" bindtap="syncToCloud">åŒæ­¥åˆ°äº‘ç«¯</button>
        </view>
        
        <view class="backup-settings">
          <view class="setting-item">
            <text class="setting-label">è‡ªåŠ¨å¤‡ä»½</text>
            <switch 
              checked="{{autoBackupEnabled}}" 
              bindchange="toggleAutoBackup"
              color="#1890ff"
            />
          </view>
        </view>
        
        <view class="backup-history" wx:if="{{backupHistory.length > 0}}">
          <text class="history-title">å¤‡ä»½å†å²</text>
          <view class="history-list">
            <view 
              class="history-item"
              wx:for="{{backupHistory}}" 
              wx:key="id"
            >
              <text class="history-time">{{formatTime(item.backupTime)}}</text>
              <text class="history-version">v{{item.version}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-primary" bindtap="closeBackupModal">ç¡®å®š</button>
      </view>
    </view>
  </view>

  <!-- åé¦ˆå¼¹çª— -->
  <view class="modal" wx:if="{{showFeedbackModal}}" bindtap="closeFeedbackModal">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="title">åŠŸèƒ½åé¦ˆ</text>
        <text class="close" bindtap="closeFeedbackModal">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="feedback-content">
          <text class="feedback-title">äº²çˆ±çš„ç”¨æˆ·ï¼Œæ‚¨å¸Œæœ›æ‘¸åº•æµ‹è¯•å¢åŠ ä»€ä¹ˆåŠŸèƒ½å‘¢ï¼Ÿ</text>
          <text class="feedback-subtitle">æˆ‘ä»¬ä¼šä¼˜å…ˆè€ƒè™‘å¹¶æŠ•å…¥å¼€å‘ã€‚</text>
          <textarea 
            class="feedback-input"
            placeholder="è¯·è¾“å…¥æ‚¨çš„å»ºè®®..."
            value="{{feedbackContent}}"
            bindinput="setFeedbackContent"
            maxlength="500"
          ></textarea>
          <text class="feedback-count">{{feedbackContent.length}}/500</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-outline" bindtap="closeFeedbackModal">å–æ¶ˆ</button>
        <button class="btn btn-primary" bindtap="submitFeedback">æäº¤</button>
      </view>
    </view>
  </view>

  <!-- ä½œä¸šé€‰æ‹©å¼¹çª— -->
  <view class="modal" wx:if="{{showAssignmentSelector}}" bindtap="closeAssignmentSelector">
    <view class="modal-content" catchtap="preventClose">
      <view class="modal-header">
        <text class="title">é€‰æ‹©ä½œä¸š</text>
        <text class="close" bindtap="closeAssignmentSelector">Ã—</text>
      </view>
      
      <view class="modal-body">
        <view class="assignment-list" wx:if="{{availableAssignments.length > 0}}">
          <view 
            class="assignment-item"
            wx:for="{{availableAssignments}}" 
            wx:key="_id"
            data-id="{{item._id}}"
            bindtap="selectAssignment"
          >
            <view class="assignment-info">
              <text class="assignment-title">{{item.title}}</text>
              <text class="assignment-desc">{{item.description}}</text>
              <view class="assignment-details">
                <text class="detail">{{item.questionCount}}é¢˜</text>
                <text class="detail">{{item.studentCount}}äººå‚ä¸</text>
                <text class="detail">æ­£ç¡®ç‡{{item.averageAccuracy}}%</text>
              </view>
            </view>
            <view class="assignment-status status-{{item.status}}">
              {{item.status === 'active' ? 'è¿›è¡Œä¸­' : item.status === 'completed' ? 'å·²å®Œæˆ' : 'å·²è¿‡æœŸ'}}
            </view>
          </view>
        </view>
        
        <view class="no-assignments" wx:else>
          <text class="no-assignments-text">æš‚æ— ä½œä¸šæ•°æ®</text>
          <text class="no-assignments-hint">å°†æ˜¾ç¤ºé»˜è®¤è¯­æ³•å¡«ç©ºé¢˜</text>
        </view>
      </view>
      
      <view class="modal-footer">
        <button class="btn btn-primary" bindtap="closeAssignmentSelector">å–æ¶ˆ</button>
      </view>
    </view>
  </view>
</view>
