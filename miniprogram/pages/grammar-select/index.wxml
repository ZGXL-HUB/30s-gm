<view class="container">

  <!-- æ™ºèƒ½æ§åˆ¶é¢æ¿ -->
  <view class="smart-control-panel">
    <view class="control-header">
      <text class="header-title">æ™ºèƒ½é€‰é¢˜</text>
      <view class="mode-switch">
        <text class="mode-label">ç²¾ç¡®æ¨¡å¼</text>
        <switch checked="{{isPreciseMode}}" bindchange="toggleMode" color="#1890ff"/>
        <text class="mode-label">å¿«é€Ÿæ¨¡å¼</text>
      </view>
    </view>
    
    <!-- ç²¾ç¡®æ¨¡å¼ï¼šæ˜¾ç¤ºå·²é€‰è¯­æ³•ç‚¹è¯¦æƒ… -->
    <view class="precise-mode" wx:if="{{isPreciseMode}}">
      <view class="selected-summary">
        <text class="summary-text">å·²é€‰ {{selectedCount}} ä¸ªè¯­æ³•ç‚¹ï¼Œå…± {{totalQuestions}} é¢˜</text>
        <view class="progress-bar">
          <view class="progress-fill" style="width: {{(totalQuestions / maxQuestions) * 100}}%"></view>
        </view>
      </view>
      
      <!-- æ‰¹é‡è°ƒèŠ‚æ§åˆ¶ -->
      <view class="batch-control" wx:if="{{selectedCount > 0}}">
        <text class="control-label">æ‰¹é‡è°ƒèŠ‚</text>
        <view class="multiplier-control">
          <text class="multiplier-label">æ¯é¢˜Ã—</text>
          <slider 
            class="multiplier-slider"
            min="1" 
            max="5" 
            value="{{multiplier}}"
            bindchange="onMultiplierChange"
            activeColor="#667eea"
          />
          <text class="multiplier-value">{{multiplier}}</text>
        </view>
      </view>
    </view>
    
    <!-- å¿«é€Ÿæ¨¡å¼ï¼šæ€»æ•°æ§åˆ¶ -->
    <view class="quick-mode" wx:else>
      <view class="total-control">
        <text class="control-label">æ€»é¢˜æ•°</text>
        <view class="total-slider-container">
          <slider 
            class="total-slider"
            min="5" 
            max="50" 
            value="{{targetTotalQuestions}}"
            bindchange="onTotalQuestionsChange"
            activeColor="#667eea"
          />
          <text class="total-value">{{targetTotalQuestions}}é¢˜</text>
        </view>
      </view>
      
      <view class="category-selection">
        <text class="selection-label">é€‰æ‹©å¤§ç±»</text>
        <view class="category-tags">
          <view 
            class="category-tag {{selectedCategories.includes(item) ? 'active' : ''}}"
            wx:for="{{availableCategories}}" 
            wx:key="*this"
            bindtap="toggleCategory"
            data-category="{{item}}"
          >
            {{item}}
          </view>
        </view>
      </view>
      
      <!-- æ™ºèƒ½åˆ†é…æç¤º -->
      <view class="smart-allocation-tip" wx:if="{{selectedCategories.length > 0}}">
        <text class="tip-text">
          ğŸ’¡ ç³»ç»Ÿå°†æ™ºèƒ½åˆ†é… {{targetTotalQuestions}} é¢˜åˆ°é€‰ä¸­çš„ {{selectedCategories.length}} ä¸ªå¤§ç±»ä¸­
        </text>
      </view>
    </view>
  </view>

  <!-- ä¸»æ»šåŠ¨åŒºåŸŸ -->
  <scroll-view scroll-y class="main-scroll-area">

    <!-- æ–°å¢ï¼šå·²é€‰æ ‡ç­¾åŒº -->
    <view class="selected-tags-section" wx:if="{{selectedTagsList.length > 0}}">
      <view class="tags-header" bindtap="toggleTagsCollapse">
        <text>å·²é€‰ {{selectedTagsList.length}} ä¸ªè€ƒç‚¹</text>
        <image class="collapse-icon" src="/images/arrow.svg" style="transform: rotate({{isTagsCollapsed ? '0deg' : '90deg'}});"></image>
      </view>
      <!-- æ–°å¢ï¼šåŠ¨æ•ˆæç¤º -->
      <view class="tip-animation" wx:if="{{showTipAnimation}}">
        <text class="tip-text">ğŸ’¡ ç‚¹è¿™é‡Œå¯ä»¥è°ƒæ•´ç»„åˆå“¦</text>
      </view>
      <view class="tags-container-wrapper {{isTagsCollapsed ? 'collapsed' : ''}}">
        <view class="tags-container">
          <block wx:for="{{selectedTagsList}}" wx:key="index" wx:for-item="tagName">
            <view class="tag-item">
              <text class="tag-text">{{tagName}}</text>
              <view class="tag-count-control">
                <view class="tag-control-btn" bindtap="decreaseTagCount" data-point="{{tagName}}">-</view>
                <text class="tag-count-text">{{selectedPoints[tagName]}}é¢˜</text>
                <view class="tag-control-btn" bindtap="increaseTagCount" data-point="{{tagName}}">+</view>
              </view>
              <text class="remove-tag-btn" bindtap="removeTag" data-point="{{tagName}}">Ã—</text>
            </view>
          </block>
        </view>
      </view>
    </view>

    <view class="grammar-tree">
      <block wx:for="{{categories}}" wx:key="index" wx:for-item="category" wx:for-index="catIndex">
        <!-- åˆ†ç±»çˆ¶èŠ‚ç‚¹ -->
        <view class="category-item" bindtap="toggleCategory" data-index="{{catIndex}}">
          <view class="category-title-wrapper">
            <text>{{category}}</text>
            <!-- æ–°å¢ï¼šåˆ†ç±»é¢˜æ•°ç»Ÿè®¡ -->
            <text class="category-count-badge" wx:if="{{categoryCounts[catIndex] > 0}}">
              {{categoryCounts[catIndex]}}
            </text>
          </view>
          <image class="collapse-icon {{expandedCategories[catIndex] ? 'rotated' : ''}}" src="/images/arrow.svg"></image>
        </view>
        <!-- å­èŠ‚ç‚¹å®¹å™¨ -->
        <view class="point-list-wrapper {{expandedCategories[catIndex] ? 'expanded' : ''}}">
          <block wx:for="{{rightPanel[catIndex]}}" wx:key="subIndex" wx:for-item="point">
            <!-- æ–°å¢ï¼šéšè—è¢«é…ç½®ä¸ºéšè—çš„è¯­æ³•ç‚¹ -->
            <view wx:if="{{!isHiddenPoint(point.name || point)}}" class="point-item {{specialCategories.indexOf(point.name || point) !== -1 ? 'special-category' : ''}}">
              <view class="point-info">
                <text class="point-name">{{point.name || point}}</text>
                <text wx:if="{{point.isHighFrequency}}" class="high-frequency-tag">[é«˜é¢‘]</text>
                <!-- ç‰¹æ®Šç±»åˆ«æ ‡è¯† -->
                <text wx:if="{{specialCategories.indexOf(point.name || point) !== -1}}" class="special-category-tag">ğŸ“</text>
              </view>
              <view class="count-control">
                <!-- æ‰€æœ‰ç±»åˆ«éƒ½ä½¿ç”¨ç»Ÿä¸€çš„+/-æŒ‰é’®ç•Œé¢ -->
                <view class="normal-control">
                  <view class="control-btn" bindtap="decreaseCount" data-point="{{point.name || point}}">-</view>
                  <text class="count-text">{{selectedPoints[point.name || point] || 0}}é¢˜</text>
                  <view class="control-btn" bindtap="increaseCount" data-point="{{point.name || point}}">+</view>
                </view>
              </view>
            </view>
          </block>
        </view>
      </block>
    </view>
  </scroll-view>

  <!-- æ–°å¢ï¼šç»¼åˆå¤§ç±»åº•éƒ¨æ“ä½œæ  -->
  <view class="combo-bar {{showComboBar ? 'show' : ''}}" wx:if="{{showComboBar}}">
    
    <!-- Preview section, only shown when a combo is set -->
    <view class="selected-combo-preview" wx:if="{{isCustomComboSet && customComboConfig && getCustomComboTotalCount() > 0}}">
      <view class="preview-header">
        <text class="preview-title">ğŸ“‹ æ‚¨çš„ä¸“å±ç»„åˆé…ç½®</text>
        <text class="preview-subtitle">å…± {{getCustomComboTotalCount()}} é¢˜</text>
      </view>
      <view class="preview-content">
        <block wx:for="{{formattedComboConfig}}" wx:key="category" wx:for-item="categoryItem">
          <view class="preview-category">
            <text class="preview-category-name">{{categoryItem.category}}</text>
            <view class="preview-sub-points">
              <block wx:for="{{categoryItem.subPoints}}" wx:key="name" wx:for-item="subPoint">
                <text class="preview-sub-point">{{subPoint.name}} ({{subPoint.count}}é¢˜)</text>
              </block>
            </view>
          </view>
        </block>
      </view>
    </view>
    
    <!-- Placeholder, only shown when a combo is NOT set -->
    <view class="no-combo-placeholder" wx:if="{{!isCustomComboSet}}">
      <text class="placeholder-icon">ğŸ¤·</text>
      <text class="placeholder-text">æ‚¨è¿˜æ²¡æœ‰è®¾ç½®ä¸“å±ç»„åˆ</text>
      <text class="placeholder-subtext">å¯ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç»„åˆï¼Œæˆ–ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è®¾ç½®</text>
    </view>

    <!-- Main action buttons -->
    <view class="combo-bar-content">
      <!-- ç³»ç»Ÿæ¨èç»„åˆåŒºåŸŸ -->
      <view class="combo-section">
        <text class="section-title">ç³»ç»Ÿæ¨èç»„åˆ</text>
        <view class="section-buttons">
          <button class="combo-btn quick-btn primary" bindtap="generateSystemCombo">
            <text class="btn-icon">âš¡</text>
            <text class="btn-text">å¿«é€Ÿç»ƒä¹ </text>
          </button>
          <button class="combo-btn settings-btn" bindtap="previewSystemCombo">
            <text class="btn-icon">ğŸ‘ï¸</text>
            <text class="btn-text">è¿‡ç›®å·²é€‰é¢˜(å¯è°ƒæ•´ï¼‰</text>
          </button>
        </view>
      </view>

      <!-- ä¸“å±ç»„åˆåŒºåŸŸ -->
      <view class="combo-section">
        <text class="section-title">ä¸“å±ç»„åˆ</text>
        <view class="section-buttons">
          <button wx:if="{{isCustomComboSet}}" class="combo-btn quick-btn primary" bindtap="generateCustomCombo">
            <text class="btn-icon">âš¡</text>
            <text class="btn-text">å¿«é€Ÿç»ƒä¹ </text>
          </button>
          <button wx:else class="combo-btn quick-btn disabled">
            <text class="btn-icon">âš¡</text>
            <text class="btn-text">å¿«é€Ÿç»ƒä¹ </text>
          </button>
          
          <button class="combo-btn settings-btn" bindtap="navigateToCustomComboSetting">
            <text class="btn-icon">âš™ï¸</text>
            <text class="btn-text">è®¾ç½®æ–°çš„ä¸“å±ç»„åˆ</text>
          </button>
        </view>
      </view>
    </view>

    <!-- Tooltip for more operations -->
    <view class="tooltip" wx:if="{{showTooltip}}">
      <text>ç‚¹å‡»æŸ¥çœ‹ä¸“å±ç»„åˆä¿®æ”¹ã€é‡ç½®ç­‰æ“ä½œ</text>
    </view>

    <!-- Menu popup -->
    <view class="menu-popup" wx:if="{{showComboMenu}}">
      <view class="menu-item" bindtap="navigateToCustomComboSetting">
        <text class="menu-item-icon">âœï¸</text>
        <text class="menu-item-text">ä¿®æ”¹æˆ‘çš„ä¸“å±ç»„åˆ</text>
      </view>
      <view class="menu-item danger" bindtap="clearCustomCombo">
        <text class="menu-item-icon">ğŸ—‘ï¸</text>
        <text class="menu-item-text">é‡ç½®æˆ‘çš„ä¸“å±ç»„åˆ</text>
      </view>
    </view>

    <!-- Close button -->
    <view class="combo-bar-close" bindtap="hideComboBar">
      <text>Ã—</text>
    </view>
  </view>

  <!-- åº•éƒ¨å›ºå®šæ“ä½œæ  -->
  <view class="bottom-bar">
    <!-- æ€»é¢˜æ•°ï¼šç‹¬ç«‹æ ‡ç­¾ -->
    <view class="total-box">
      æ€»é¢˜æ•°ï¼š<text class="count">{{totalQuestions}}</text>
    </view>
    <!-- æ“ä½œæŒ‰é’®åŒº -->
    <view class="actions">
      <button class="bar-btn clear-btn" bindtap="clearSelected" disabled="{{totalQuestions === 0}}">æ¸…ç©º</button>
      <button class="bar-btn generate-btn" loading="{{generating}}" bindtap="generateQuestions" disabled="{{totalQuestions === 0}}">ç¡®è®¤ç”Ÿæˆ</button>
    </view>
  </view>
</view>
<!-- TabBar ç”±å°ç¨‹åºè‡ªåŠ¨æ¸²æŸ“ï¼Œæ— éœ€æ‰‹åŠ¨å†™å…¥WXML -->