<view class="container">
  <!-- æµ‹è¯•å…¥å£å¡ç‰‡ -->
  <view class="test-entry-card" bindtap="navigateToWritingTest">
    <image src="/images/icon-writing-test.png" class="test-icon"></image>
    <text class="test-title">ä¹¦å†™èƒ½åŠ›æµ‹è¯„</text>
    <text class="test-desc">å…¨é¢è¯„ä¼°ä¹¦å†™èƒ½åŠ›ï¼Œå‘ç°æå‡ç©ºé—´</text>
    <view class="test-button">å¼€å§‹æµ‹è¯•</view>
  </view>

  <!-- é¡µé¢å¼•å¯¼å¡ç‰‡ -->
  <page-header-guide 
    title="è¯­æ³•ä¹¦å†™ç»ƒä¹ "
    description="é€‰æ‹©ä¸åŒç±»å‹çš„è¯­æ³•ç»ƒä¹ è¡¨æ ¼ï¼Œç‚¹å‡»å¼€å§‹ç­”é¢˜ï¼Œæå‡è¯­æ³•åº”ç”¨èƒ½åŠ›"
    tip="ğŸ’¡ æç¤ºï¼šå¯ä»¥åŒæ—¶é€‰æ‹©å¤šä¸ªè¡¨æ ¼è¿›è¡Œç»„åˆç»ƒä¹ "
    icon="âœï¸"
    storage-key="grammar-writing-guide"
  />
  
  <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
  <scroll-view scroll-y class="main-content">
    <!-- åˆ†ç±»åˆ—è¡¨ -->
    <view class="category-list">
      <block wx:for="{{categories}}" wx:key="index" wx:for-item="category" wx:for-index="catIndex">
        <!-- åˆ†ç±»çˆ¶èŠ‚ç‚¹ -->
        <view class="category-item" bindtap="toggleCategory" data-index="{{catIndex}}">
          <view class="category-title-wrapper">
            <text class="category-name">{{category}}</text>
            <text class="category-count" wx:if="{{catIndex === 0 && pronounTables.length > 0}}">
              {{pronounTables.length}}ä¸ªè¡¨æ ¼
            </text>
            <text class="category-count" wx:if="{{catIndex === 1 && nounTables.length > 0}}">
              {{nounTables.length}}ä¸ªè¡¨æ ¼
            </text>
            <text class="category-count" wx:if="{{catIndex === 2 && verbTables.length > 0}}">
              {{verbTables.length}}ä¸ªè¡¨æ ¼
            </text>
            <text class="category-count" wx:if="{{catIndex === 3 && tenseTables.length > 0}}">
              {{tenseTables.length}}ä¸ªè¡¨æ ¼
            </text>
            <text class="category-count" wx:if="{{catIndex === 4 && voiceTables.length > 0}}">
              {{voiceTables.length}}ä¸ªè¡¨æ ¼
            </text>
            <text class="category-count" wx:if="{{catIndex === 5 && comparisonTables.length > 0}}">
              {{comparisonTables.length}}ä¸ªè¡¨æ ¼
            </text>
            <text class="category-count" wx:if="{{catIndex === 6 && adverbTables.length > 0}}">
              {{adverbTables.length}}ä¸ªè¡¨æ ¼
            </text>
          </view>
        </view>
        
        <!-- å­èŠ‚ç‚¹å®¹å™¨ -->
        <view class="sub-categories-wrapper {{expandedCategories[catIndex] ? 'expanded' : ''}}">
          <!-- ä»£è¯éƒ¨åˆ† -->
          <block wx:if="{{catIndex === 0}}">
            <view class="sub-category-item" wx:for="{{pronounSubCategories}}" wx:key="subIndex" wx:for-item="subCategory" wx:for-index="subIndex" 
                  bindtap="selectTable" 
                  data-table-id="{{pronounTables[subIndex].table_id}}"
                  wx:if="{{pronounTables[subIndex]}}">
              <view class="sub-category-info">
                <text class="sub-category-name">{{subCategory}}</text>
              </view>
              <view class="selection-control">
                <view class="select-btn {{selectedTables[pronounTables[subIndex].table_id] ? 'selected' : ''}}">
                  <text class="select-icon">{{selectedTables[pronounTables[subIndex].table_id] ? 'âœ“' : '+'}}</text>
                </view>
              </view>
            </view>
            
            <!-- æç¤ºå’Œç­”æ¡ˆæŒ‰é’® -->
            <view class="action-buttons" wx:if="{{catIndex === 0}}">
              <button class="action-btn hint-btn" bindtap="showHintOptions" data-category-index="0">
                <text class="btn-icon">ğŸ’¡</text>
                <text class="btn-text">å°å°çš„æç¤º</text>
              </button>
              <button class="action-btn answer-btn" bindtap="showFullAnswer" data-table-id="pronoun_001" data-category-index="0">
                <text class="btn-icon">ğŸ“š</text>
                <text class="btn-text">æˆ‘å†è®°ä¼šå„¿</text>
              </button>
            </view>
          </block>
          
          <!-- åè¯å˜å¤æ•°éƒ¨åˆ† -->
          <block wx:if="{{catIndex === 1}}">
            <view class="sub-category-item" wx:for="{{nounSubCategories}}" wx:key="subIndex" wx:for-item="subCategory" wx:for-index="subIndex"
                  bindtap="selectTable" 
                  data-table-id="{{nounTables[subIndex].table_id}}"
                  wx:if="{{nounTables[subIndex]}}">
              <view class="sub-category-info">
                <text class="sub-category-name">{{subCategory}}</text>
              </view>
              <view class="selection-control">
                <view class="select-btn {{selectedTables[nounTables[subIndex].table_id] ? 'selected' : ''}}">
                  <text class="select-icon">{{selectedTables[nounTables[subIndex].table_id] ? 'âœ“' : '+'}}</text>
                </view>
              </view>
            </view>
            <!-- æ–°å¢ï¼šåè¯å˜å¤æ•°ä¸‹æ–¹ä¸¤ä¸ªæç¤ºæŒ‰é’® -->
            <view class="noun-hint-bar">
              <button class="noun-hint-btn" bindtap="showNounSuffixHint"><text class="noun-hint-icon">ğŸ’¡</text>å…³äºåè¯åç¼€</button>
              <button class="noun-hint-btn" bindtap="showNounPluralHint"><text class="noun-hint-icon">ğŸ“š</text>å…³äºåè¯å¤æ•°</button>
            </view>
          </block>
          
          <!-- åŠ¨è¯åˆ†è¯ä¹¦å†™éƒ¨åˆ† -->
          <block wx:if="{{catIndex === 2}}">
            <view class="sub-category-item" wx:for="{{verbSubCategories}}" wx:key="subIndex" wx:for-item="subCategory" wx:for-index="subIndex"
                  bindtap="selectTable" 
                  data-table-id="{{verbTables[subIndex].table_id}}"
                  wx:if="{{verbTables[subIndex]}}">
              <view class="sub-category-info">
                <text class="sub-category-name">{{subCategory}}</text>
              </view>
              <view class="selection-control">
                <view class="select-btn {{selectedTables[verbTables[subIndex].table_id] ? 'selected' : ''}}">
                  <text class="select-icon">{{selectedTables[verbTables[subIndex].table_id] ? 'âœ“' : '+'}}</text>
                </view>
              </view>
            </view>
            <!-- åˆ†è¯æç¤ºæŒ‰é’® -->
            <view class="verb-hint-bar">
              <button class="verb-hint-btn" bindtap="showPresentParticipleRules"><text class="verb-hint-icon">ğŸ’¡</text>ç°åœ¨åˆ†è¯ä¹¦å†™</button>
              <button class="verb-hint-btn" bindtap="showPastParticipleRules"><text class="verb-hint-icon">ğŸ“š</text>è¿‡å»åˆ†è¯ä¹¦å†™</button>
            </view>
          </block>
          
          <!-- æ—¶æ€ä¹¦å†™éƒ¨åˆ† -->
          <block wx:if="{{catIndex === 3}}">
            <!-- è¡¨æ ¼ç»ƒä¹ é€‰é¡¹ -->
            <view class="sub-category-item" wx:for="{{tenseSubCategories}}" wx:key="subIndex" wx:for-item="subCategory" wx:for-index="subIndex"
                  bindtap="selectTable" 
                  data-table-id="{{tenseTables[subIndex].table_id}}"
                  wx:if="{{tenseTables[subIndex]}}">
              <view class="sub-category-info">
                <text class="sub-category-name">{{subCategory}}</text>
              </view>
              <view class="selection-control">
                <view class="select-btn {{selectedTables[tenseTables[subIndex].table_id] ? 'selected' : ''}}">
                  <text class="select-icon">{{selectedTables[tenseTables[subIndex].table_id] ? 'âœ“' : '+'}}</text>
                </view>
              </view>
            </view>
            
            <!-- æ—¶æ€æç¤ºæŒ‰é’® -->
            <view class="tense-hint-bar">
              <button class="tense-hint-btn" bindtap="showTenseWritingRules"><text class="tense-hint-icon">ğŸ’¡</text>æ—¶æ€ä¹¦å†™è§„åˆ™</button>
              <button class="tense-hint-btn" bindtap="showTenseSignalRules"><text class="tense-hint-icon">ğŸ“š</text>æ—¶æ€æ ‡å¿—è¯è¯†åˆ«</button>
            </view>
          </block>
          
          <!-- è¯­æ€ä¹¦å†™éƒ¨åˆ† -->
          <block wx:if="{{catIndex === 4}}">
            <!-- è¡¨æ ¼ç»ƒä¹ é€‰é¡¹ -->
            <view class="sub-category-item" wx:for="{{voiceSubCategories}}" wx:key="subIndex" wx:for-item="subCategory" wx:for-index="subIndex"
                  bindtap="selectTable" 
                  data-table-id="{{voiceTables[subIndex].table_id}}"
                  wx:if="{{voiceTables[subIndex]}}">
              <view class="sub-category-info">
                <text class="sub-category-name">{{subCategory}}</text>
              </view>
              <view class="selection-control">
                <view class="select-btn {{selectedTables[voiceTables[subIndex].table_id] ? 'selected' : ''}}">
                  <text class="select-icon">{{selectedTables[voiceTables[subIndex].table_id] ? 'âœ“' : '+'}}</text>
                </view>
              </view>
            </view>
            
            <!-- è¯­æ€æç¤ºæŒ‰é’® -->
            <view class="voice-hint-bar">
              <button class="voice-hint-btn" bindtap="showVoiceRules"><text class="voice-hint-icon">ğŸ’¡</text>è¯­æ€è§„åˆ™æç¤º</button>
            </view>
          </block>
          
          <!-- æ¯”è¾ƒçº§æœ€é«˜çº§éƒ¨åˆ† -->
          <block wx:if="{{catIndex === 5}}">
            <view class="sub-category-item" wx:for="{{comparisonSubCategories}}" wx:key="subIndex" wx:for-item="subCategory" wx:for-index="subIndex"
                  bindtap="selectTable" 
                  data-table-id="{{comparisonTables[subIndex].table_id}}"
                  wx:if="{{comparisonTables[subIndex]}}">
              <view class="sub-category-info">
                <text class="sub-category-name">{{subCategory}}</text>
              </view>
              <view class="selection-control">
                <view class="select-btn {{selectedTables[comparisonTables[subIndex].table_id] ? 'selected' : ''}}">
                  <text class="select-icon">{{selectedTables[comparisonTables[subIndex].table_id] ? 'âœ“' : '+'}}</text>
                </view>
              </view>
            </view>
            <!-- æ¯”è¾ƒçº§æœ€é«˜çº§æç¤ºæŒ‰é’® -->
            <view class="comparison-hint-bar">
              <button class="comparison-hint-btn" bindtap="showAdjectivePrefixSuffixRules"><text class="comparison-hint-icon">ğŸ’¡</text>å½¢å®¹è¯å‰åç¼€</button>
              <button class="comparison-hint-btn" bindtap="showComparisonWritingRules"><text class="comparison-hint-icon">ğŸ“š</text>æ¯”è¾ƒçº§æœ€é«˜çº§ä¹¦å†™</button>
            </view>
          </block>
          
          <!-- å½¢å®¹è¯å˜å‰¯è¯éƒ¨åˆ† -->
          <block wx:if="{{catIndex === 6}}">
            <view class="sub-category-item" wx:for="{{adverbSubCategories}}" wx:key="subIndex" wx:for-item="subCategory" wx:for-index="subIndex"
                  bindtap="selectTable" 
                  data-table-id="{{adverbTables[subIndex].table_id}}"
                  wx:if="{{adverbTables[subIndex]}}">
              <view class="sub-category-info">
                <text class="sub-category-name">{{subCategory}}</text>
              </view>
              <view class="selection-control">
                <view class="select-btn {{selectedTables[adverbTables[subIndex].table_id] ? 'selected' : ''}}">
                  <text class="select-icon">{{selectedTables[adverbTables[subIndex].table_id] ? 'âœ“' : '+'}}</text>
                </view>
              </view>
            </view>
            <!-- å‰¯è¯æç¤ºæŒ‰é’® -->
            <view class="adverb-hint-bar">
              <button class="adverb-hint-btn" bindtap="showAdverbWritingRules"><text class="adverb-hint-icon">ğŸ’¡</text>å½¢å®¹è¯å˜å‰¯è¯ä¹¦å†™</button>
            </view>
          </block>
          
          <!-- å…¶ä»–åˆ†ç±»ï¼ˆæš‚æ—¶æ˜¾ç¤ºå¼€å‘ä¸­ï¼‰ -->
          <block wx:if="{{catIndex > 6}}">
            <view class="sub-category-item">
              <view class="sub-category-info">
                <text class="sub-category-name">å¼€å‘ä¸­...</text>
                <text class="table-description">è¯¥åˆ†ç±»çš„è¡¨æ ¼æ­£åœ¨å¼€å‘ä¸­</text>
              </view>
            </view>
          </block>
        </view>
      </block>
    </view>
  </scroll-view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar">
    <view class="total-box">
      å·²é€‰æ‹©ï¼š<text class="count">{{selectedCount}}</text>ä¸ªè¡¨æ ¼
    </view>
    <view class="actions">
      <button class="bar-btn clear-btn" bindtap="clearSelection" disabled="{{selectedCount === 0}}">
        æ¸…ç©º
      </button>
      <button class="bar-btn start-btn" bindtap="startPractice" disabled="{{selectedCount === 0}}">
        å¼€å§‹ç»ƒä¹ 
      </button>
    </view>
  </view>

  <!-- æç¤ºé€‰é¡¹å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showHintModal}}" bindtap="closeHintModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©æç¤ºç±»å‹</text>
        <text class="modal-close" bindtap="closeHintModal">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="hint-options">
          <view class="hint-option" 
                wx:for="{{hintOptions}}" 
                wx:key="index" 
                wx:for-item="option"
                bindtap="selectHintType" 
                data-type="{{option}}">
            <text class="hint-text">{{option}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æç¤ºå†…å®¹å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showHintContentModal}}" bindtap="closeHintContentModal">
    <view class="modal-content" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æç¤º</text>
        <text class="modal-close" bindtap="closeHintContentModal">Ã—</text>
      </view>
      <view class="modal-body">
        <text style="font-size:28rpx;line-height:1.7;white-space:pre-line;">{{hintContent}}</text>
      </view>
    </view>
  </view>

  <!-- ç­”æ¡ˆå¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showAnswerModal}}" bindtap="closeAnswerModal">
    <view class="modal-content answer-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">{{currentAnswer.title}}</text>
        <text class="modal-close" bindtap="closeAnswerModal">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="answer-table">
          <view class="table-header">
            <view class="table-cell header-cell" wx:for="{{currentAnswer.headers}}" wx:key="index">
              {{item}}
            </view>
          </view>
          <view class="table-row" wx:for="{{currentAnswer.data}}" wx:key="rowIndex" wx:for-item="row" wx:for-index="rowIndex">
            <view class="table-cell" wx:for="{{row}}" wx:key="colIndex" wx:for-item="cell" wx:for-index="colIndex">
              {{cell}}
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view> 