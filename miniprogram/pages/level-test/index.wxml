<!--pages/level-test/index.wxml-->
<view class="container">
  <!-- æ¬¢è¿ç•Œé¢ -->
  <view class="welcome-screen" wx:if="{{testState === 'welcome'}}">
    <view class="welcome-content">
      <view class="welcome-title">ğŸ¯ è¯­æ³•æ°´å¹³æµ‹è¯•</view>
      <view class="welcome-message">
        äº²çˆ±çš„ç”¨æˆ·ï¼Œç°åœ¨è®©æˆ‘ä»¬é€šè¿‡åé“é¢˜æµ‹ä¸€æµ‹æ‚¨çš„è¯­æ³•æ°´å¹³ï¼Œæˆ‘ä¼šæ ¹æ®æ‚¨çš„æµ‹è¯•ç»“æœç»™å‡ºé’ˆå¯¹æ€§çš„ä½¿ç”¨è¯´æ˜å“¦ï¼æœ¬æ¬¡æµ‹è¯•åªä¼šåœ¨æ‚¨ç¬¬ä¸€æ¬¡ç™»é™†çš„æ—¶å€™å±•ç¤ºã€‚
      </view>
      <button class="start-btn" bindtap="startGrammarTest">è¿›å…¥æµ‹è¯•</button>
      <button class="exit-btn" bindtap="exitTest">é€€å‡ºæµ‹è¯•</button>
      <button class="preview-btn" bindtap="previewLevelResults">é¢„è§ˆå„ç­‰çº§ç»“æœ</button>
      <button class="test-btn" bindtap="testOptionClick">æµ‹è¯•é€‰é¡¹ç‚¹å‡»</button>
      <button class="debug-btn" bindtap="debugOptionClick">è°ƒè¯•é€‰é¡¹é—®é¢˜</button>
    </view>
  </view>

  <!-- è¯­æ³•æµ‹è¯•ç•Œé¢ -->
  <view class="test-screen" wx:if="{{testState === 'grammar-test'}}">
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progress}}%"></view>
    </view>
    
    <view class="question-card">
      <view class="question-header">
        <text class="question-number">ç¬¬{{currentQuestionIndex + 1}}é¢˜</text>
        <text class="question-type">è¯­æ³•é€‰æ‹©é¢˜</text>
      </view>
      
      <view class="question-content">
        <text class="question-text">{{currentQuestion.question}}</text>
      </view>
      
      <view class="options-container">
        <view 
          class="option-item {{showAnswer && option.isCorrect ? 'correct' : ''}} {{showAnswer && !option.isCorrect ? 'incorrect' : ''}}"
          wx:for="{{currentQuestion.options}}" 
          wx:key="label"
          wx:for-item="option"
          data-index="{{index}}"
          bindtap="selectGrammarAnswer"
        >
          <text class="option-label">{{option.label}}</text>
          <text class="option-text">{{option.text}}</text>
        </view>
      </view>
      
      <view class="answer-feedback" wx:if="{{showAnswer}}">
        <view class="feedback-icon {{isCorrect ? 'correct' : 'incorrect'}}">
          {{isCorrect ? 'âœ“' : 'âœ—'}}
        </view>
        <view class="feedback-text">
          {{isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'æ­£ç¡®ç­”æ¡ˆï¼š' + correctAnswerText}}
        </view>
        <view class="analysis" wx:if="{{currentQuestion.analysis}}">
          {{currentQuestion.analysis}}
        </view>
      </view>
    </view>
  </view>

  <!-- è¯­æ³•æµ‹è¯•å®Œæˆè¿‡æ¸¡ç•Œé¢ -->
  <view class="transition-screen" wx:if="{{testState === 'grammar-complete'}}">
    <view class="transition-content">
      <view class="transition-title">ğŸ‰ å¤ªæ£’äº†ï¼</view>
      <view class="transition-message">
        æ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹çœ‹æ‚¨å¯¹ä¸åŒè¯æ€§ä¹¦å†™çš„æŒæ¡æƒ…å†µï¼ŒåŠ æ²¹å“¦ï¼
      </view>
      <button class="continue-btn" bindtap="startWritingTest">å¼€å§‹æµ‹è¯•</button>
    </view>
  </view>

  <!-- ä¹¦å†™æµ‹è¯•ç•Œé¢ -->
  <view class="test-screen" wx:if="{{testState === 'writing-test'}}">
    <view class="progress-bar">
      <view class="progress-fill" style="width: {{progress}}%"></view>
    </view>
    
    <view class="question-card">
      <view class="question-header">
        <text class="question-number">ç¬¬{{currentQuestionIndex + 6}}é¢˜</text>
        <text class="question-type">ä¹¦å†™å¡«ç©ºé¢˜</text>
      </view>
      
      <view class="question-content">
        <text class="question-text">{{currentQuestion.question}}</text>
      </view>
      
      <view class="answer-input-container">
        <input 
          class="answer-input" 
          placeholder="è¯·è¾“å…¥ç­”æ¡ˆï¼ˆç©ºç­”æ¡ˆå°†è®°ä¸ºé”™è¯¯ï¼‰" 
          value="{{userInput}}"
          bindinput="inputWritingAnswer"
          bindconfirm="submitWritingAnswer"
        />
        <button class="submit-btn" bindtap="submitWritingAnswer">æäº¤</button>
      </view>
      
      <view class="answer-tip">
        <text class="tip-text">ğŸ’¡ æç¤ºï¼šæœªå¡«å†™ç­”æ¡ˆå°†è‡ªåŠ¨è®°ä¸ºé”™è¯¯ï¼Œè¯·è®¤çœŸä½œç­”</text>
      </view>
      
      <view class="answer-feedback" wx:if="{{showAnswer}}">
        <view class="feedback-icon {{isCorrect ? 'correct' : 'incorrect'}}">
          {{isCorrect ? 'âœ“' : 'âœ—'}}
        </view>
        <view class="feedback-text">
          {{isCorrect ? 'å›ç­”æ­£ç¡®ï¼' : 'æ­£ç¡®ç­”æ¡ˆï¼š' + currentQuestion.answer}}
        </view>
        <view class="analysis" wx:if="{{currentQuestion.analysis}}">
          {{currentQuestion.analysis}}
        </view>
      </view>
    </view>
  </view>

  <!-- æµ‹è¯•ç»“æœç•Œé¢ -->
  <view class="result-screen" wx:if="{{testState === 'result'}}">
    <scroll-view class="result-scroll" scroll-y="true" enhanced="true" show-scrollbar="false">
      <view class="result-content">
      <view class="result-title">ğŸŠ æ­å–œæ‚¨å®Œæˆäº†è¯­æ³•è‡ªæµ‹ï¼</view>
      <view class="result-subtitle">å¿«æ¥çœ‹çœ‹æ‚¨çš„æˆ˜ç»©å’Œæ¨èçš„å­¦ä¹ è·¯å¾„å§~</view>
      
      <view class="result-stats">
        <view class="stat-item">
          <text class="stat-label">è¯­æ³•é¢˜æ­£ç¡®ç‡</text>
          <text class="stat-value">{{testResults.grammarCorrect}}/5</text>
          <text class="stat-level">{{testResults.grammarLevel}}</text>
        </view>
        <view class="stat-item">
          <text class="stat-label">ä¹¦å†™é¢˜æ­£ç¡®ç‡</text>
          <text class="stat-value">{{testResults.writingCorrect}}/5</text>
          <text class="stat-level">{{testResults.writingLevel}}</text>
        </view>
        <view class="stat-item total">
          <text class="stat-label">æ€»æ­£ç¡®ç‡</text>
          <text class="stat-value">{{testResults.totalCorrect}}/10</text>
          <text class="stat-level">{{testResults.totalLevel}}</text>
        </view>
      </view>
      
      <view class="user-level-section">
        <view class="user-level-title">ç”¨æˆ·ç­‰çº§ï¼š{{testResults.userLevel}}</view>
        <view class="user-level-message">{{testResults.suggestion}}</view>
      </view>
      
      <view class="recommendation-section">
        <view class="recommendation-title">æ¨èå­¦ä¹ è·¯å¾„</view>
        <view class="recommendation-content">
          <view class="recommendation-text">
            å»ºè®®ä»{{testResults.recommendation}}å¼€å§‹å­¦ä¹ 
          </view>
          <view class="next-steps">
            <view class="next-steps-title">å»ºè®®å­¦ä¹ æ­¥éª¤ï¼š</view>
            <view class="next-steps-list">
              <view class="next-step-item" wx:for="{{testResults.nextSteps}}" wx:key="index">
                <text>â€¢ {{item}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- å…·ä½“æ¨èç»ƒä¹ å¡ç‰‡ -->
      <view class="specific-recommendations" wx:if="{{testResults.specificRecommendations.length > 0}}">
        <view class="specific-recommendations-title">ğŸ¯ ä¸ºæ‚¨æ¨èçš„ç»ƒä¹ </view>
        <view class="specific-recommendations-list">
          <view 
            class="recommendation-card" 
            wx:for="{{testResults.specificRecommendations}}" 
            wx:key="index"
            bindtap="startSpecificRecommendation"
            data-index="{{index}}"
          >
            <view class="recommendation-card-header">
              <view class="recommendation-icon">{{item.icon}}</view>
              <view class="recommendation-card-title">{{item.title}}</view>
            </view>
            <view class="recommendation-card-description">{{item.description}}</view>
            <view class="recommendation-card-arrow">â†’</view>
          </view>
        </view>
      </view>
      
      <!-- 24é¢˜å®Œæ•´ç‰ˆæµ‹è¯•å…¥å£ -->
      <view class="comprehensive-test-section">
        <view class="comprehensive-test-title">ğŸ“ æƒ³è¦æ›´è¯¦ç»†çš„ä¹¦å†™èƒ½åŠ›è¯„ä¼°ï¼Ÿ</view>
        <view class="comprehensive-test-desc">24é¢˜å…¨é¢ç‰ˆä¹¦å†™æµ‹è¯•ï¼Œç²¾å‡†ç­›æŸ¥19ä¸ªè¡¨æ ¼æŒæ¡æƒ…å†µ</view>
        <button class="comprehensive-test-btn" bindtap="goToComprehensiveTest">
          å¼€å§‹24é¢˜å…¨é¢æµ‹è¯•
        </button>
      </view>

      <!-- ä¸ªæ€§åŒ–æ¨èå…¥å£ -->
      <view class="recommendation-actions">
        <view class="recommendation-actions-title">ğŸš€ ç«‹å³å¼€å§‹å­¦ä¹ </view>
        <view class="recommendation-buttons">
          <button 
            class="recommendation-btn primary" 
            bindtap="startRecommendedLearning"
            data-type="{{testResults.recommendation}}"
          >
            {{testResults.recommendation}}
          </button>
          <button 
            class="recommendation-btn secondary" 
            bindtap="viewLearningPath"
          >
            æŸ¥çœ‹å­¦ä¹ è·¯å¾„
          </button>
        </view>
      </view>

      <view class="action-buttons">
        <button class="retake-btn" bindtap="retakeTest">é‡æ–°æµ‹è¯•</button>
        <button class="view-result-btn" bindtap="viewTestResults">æŸ¥çœ‹æµ‹è¯•ç»“æœ</button>
        <button class="complete-btn" bindtap="completeTest">å®Œæˆæµ‹è¯•</button>
      </view>
      </view>
    </scroll-view>
  </view>

  <!-- é¢„è§ˆå„ç­‰çº§ç»“æœç•Œé¢ -->
  <view class="preview-screen" wx:if="{{testState === 'preview'}}">
    <view class="preview-content">
      <view class="preview-header">
        <view class="preview-title">ğŸ” å„ç­‰çº§ç»“æœé¢„è§ˆ</view>
        <view class="close-btn" bindtap="closePreview">Ã—</view>
      </view>
      
      <scroll-view class="preview-scroll" scroll-y="true" enhanced="true" show-scrollbar="false">
        <view class="level-preview-list">
          <view wx:for="{{previewLevels}}" wx:key="level" wx:for-item="levelData" class="level-preview-item">
            <view class="level-preview-header">
              <view class="level-preview-title">{{levelData.title}}</view>
              <view class="level-preview-subtitle">{{levelData.subtitle}}</view>
            </view>
            
            <view class="level-preview-stats">
              <view class="stat-item">
                <text class="stat-label">è¯­æ³•é¢˜æ­£ç¡®ç‡</text>
                <text class="stat-value">{{levelData.grammarCorrect}}/5</text>
                <text class="stat-level">{{levelData.grammarLevel}}</text>
              </view>
              <view class="stat-item">
                <text class="stat-label">ä¹¦å†™é¢˜æ­£ç¡®ç‡</text>
                <text class="stat-value">{{levelData.writingCorrect}}/5</text>
                <text class="stat-level">{{levelData.writingLevel}}</text>
              </view>
              <view class="stat-item total">
                <text class="stat-label">æ€»æ­£ç¡®ç‡</text>
                <text class="stat-value">{{levelData.totalCorrect}}/10</text>
                <text class="stat-level">{{levelData.totalLevel}}</text>
              </view>
            </view>
            
            <view class="level-preview-user-level">
              <view class="user-level-title">ç”¨æˆ·ç­‰çº§ï¼š{{levelData.userLevel}}</view>
              <view class="user-level-message">{{levelData.suggestion}}</view>
            </view>
            
            <view class="level-preview-recommendations">
              <view class="recommendation-title">æ¨èæ¨¡å—</view>
              <view class="recommendation-content">{{levelData.recommendation}}</view>
              <view class="suggestion-content">{{levelData.suggestion}}</view>
            </view>
            
            <view class="level-preview-actions">
              <view class="next-steps-title">ä¸‹ä¸€æ­¥å»ºè®®ï¼š</view>
              <view class="next-steps-list">
                <view wx:for="{{levelData.nextSteps}}" wx:key="index" wx:for-item="step" class="next-step-item">
                  â€¢ {{step}}
                </view>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>
